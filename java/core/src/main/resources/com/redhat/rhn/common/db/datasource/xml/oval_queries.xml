<datasource_modes>
    <callable-mode name="add_product_vulnerable_package">
        <query params="package_name, fix_epoch, fix_version, fix_release, fix_type, product_name, cve_name">
            call insert_product_vulnerable_packages(:package_name, :fix_epoch, :fix_version, :fix_release, :fix_type, :product_name, :cve_name)
        </query>
    </callable-mode>

    <mode name="get_vulnerable_packages">
        <query params="cve_name, server_id">
            SELECT cve.name,
                vulnerablePkg.name AS package_name,
                (vulnerablePkg.fix_version).epoch AS fix_epoch,
                (vulnerablePkg.fix_version).version AS fix_version,
                (vulnerablePkg.fix_version).release AS fix_release,
                (vulnerablePkg.fix_version).type AS fix_type,
                vulnerablePkg.fix_version IS NULL
                  OR vulnerablePkg.fix_version > pe.evr AS affected
            FROM rhnCVE cve
            JOIN suseovalplatformvulnerable platVulnerable
              ON platVulnerable.cve_id = cve.id
                AND cve.name = :cve_name
            JOIN suseovalplatform platform
              ON platform.id = platVulnerable.platform_id
            JOIN rhnServer s
              ON s.cpe = platform.cpe
                AND s.id = :server_id
            JOIN suseovalvulnerablepackage vulnerablePkg
              ON vulnerablePkg.plat_vuln_id = platVulnerable.id
            JOIN rhnPackageName pn
              ON pn.name = vulnerablePkg.name
            JOIN rhnServerPackage sp
              ON sp.server_id = s.id
                AND sp.name_id = pn.id
            JOIN rhnPackageEVR pe
              ON pe.id = sp.evr_id;
        </query>
    </mode>

    <mode name="can_audit_cve">
        <query params="cve_name">
            SELECT 1
            FROM suseOVALPlatformVulnerable platVul,
                 rhncve cve
            WHERE platVul.cve_id = cve.id
              AND cve.name = :cve_name;
        </query>
    </mode>

    <mode name="check_oval_availability">
        <query params="cpe">
            SELECT 1 FROM suseOVALPlatform plat WHERE starts_with(:cpe, plat.cpe);
        </query>
    </mode>

    <mode name="check_errata_availability">
        <query params="server_id">
            SELECT 1
            FROM suseCVEServerChannel,
                 rhnChannelErrata
            WHERE suseCVEServerChannel.channel_id = rhnChannelErrata.channel_id
              AND server_id = :server_id
        </query>
    </mode>

    <write-mode name="clear_oval_metadata_by_platform">
        <query params="cpe">
            DELETE FROM suseOVALPlatform plat where plat.cpe = :cpe;
        </query>
    </write-mode>
</datasource_modes>
