name: test-all-in-one
on: pull_request
env:
  UYUNI_PROJECT: jordimassaguerpla
  UYUNI_VERSION: master
jobs:
  test-uyuni:
    runs-on: ubuntu-latest
    steps:
      - name: my-step
        run: echo "Starting..."
      - name: create_tmp
        run: bash -c "rm -rf /tmp/test-all-in-one && mkdir /tmp/test-all-in-one"
      - uses: actions/checkout@v3
      - name: Cache-jar-files
        uses: actions/cache@v3
        with:
          path: java/buildconf/ivy/repository/
          key: ${{ runner.os }}-build-cache-uyuni-jars-${{ hashFiles('**/java/buildconf/ivy/*.xml') }}
          restore-keys: |
            ${{ runner.os }}-build-cache-uyuni-jars-

      - name: Cache-obs-to-maven files
        uses: actions/cache@v3
        with:
          path: java/.obs-to-maven-cache
          key: ${{ runner.os }}-build-cache-uyuni-obs-to-maven-${{ hashFiles('**/java/buildconf/ivy/obs-maven-config.yaml') }}
          restore-keys: |
            ${{ runner.os }}-build-cache-uyuni-obs-to-maven-
      - name: Cache-nodejs
        uses: actions/cache@v3
        with:
          path: web/html/src/node_modules
          key: ${{ runner.os }}-build-cache-uyuni-nodejs-${{ hashFiles('**/web/html/src/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-build-cache-uyuni-nodejs-
      - name: create-docker-network
        run: docker network create uyuni-network-1
      - name: start_controller
        run: docker run --rm -d --network uyuni-network-1 -v /tmp/test-all-in-one:/tmp --name controller-test-1 -h controller-test-1 -v /home/runner/work/uyuni/uyuni/testsuite:/testsuite ghcr.io/$UYUNI_PROJECT/uyuni/controller-dev:$UYUNI_VERSION
      - name: sleep5
        run: sleep 5
      - name: docker_ps
        run: docker ps
      - name: create_ssh_conf
        run: docker exec controller-test-1 bash -c "ssh-keygen -f /root/.ssh/id_rsa -t rsa -N \"\" && cp /root/.ssh/id_rsa.pub /tmp/authorized_keys && cd /testsuite && bundle.ruby2.5 install --gemfile Gemfile"
      - name: start-server-container
        run: docker run --rm --tmpfs /run -v /home/runner/work/uyuni/uyuni/schema/spacewalk/upgrade/:/etc/sysconfig/rhn/schema-upgrade/ -v /home/runner/work/uyuni/uyuni/schema/reportdb/upgrade/:/etc/sysconfig/rhn/reportdb-schema-upgrade/ -v /home/runner/work/uyuni/uyuni/web:/web -v /home/runner/work/uyuni/uyuni/branding:/branding -v /home/runner/work/uyuni/uyuni/java:/java -v /sys/fs/cgroup:/sys/fs/cgroup:rw -v /tmp/test-all-in-one:/tmp  --cgroupns=host --add-host=download.opensuse.org:195.135.221.134 -h uyuni-server-all-in-one-test-1 -p 8443:443 -p 8080:80 -p 4505:4505 -p 4506:4506 -d --name=uyuni-server-all-in-one-test-1 --network uyuni-network-1 ghcr.io/$UYUNI_PROJECT/uyuni/server-all-in-one-dev:$UYUNI_VERSION
      - name: mgr-setup
        run: docker exec uyuni-server-all-in-one-test-1 bash -c "/usr/lib/susemanager/bin/mgr-setup -l /var/log/susemanager_setup.log -s"
      - name: java-build
        run: docker exec uyuni-server-all-in-one-test-1 bash -c "cd /java && ant -f manager-build.xml ivy refresh-branding-jar deploy-local"
      - name: js-build
        run: docker exec uyuni-server-all-in-one-test-1 bash -c "cd /web/html/src;[ -d dist ] || mkdir dist;yarn install --force --ignore-optional --production=true --frozen-lockfile;yarn autoclean --force;yarn build:novalidate; rsync -a dist/ /srv/www/htdocs/"
      - name: sle-ssh-minion
        run: docker run --rm -d --network uyuni-network-1 -v /tmp/test-all-in-one:/tmp --name ssh-minion -h ssh-minion ghcr.io/$UYUNI_PROJECT/uyuni/sle-minion:$UYUNI_VERSION
      - name: docker-ps
        run: docker ps
      - name: test_from_host
        run: curl --insecure https://localhost:8443/rhn/help/Copyright.do
      - name: test_from_container
        run: docker exec ssh-minion curl --insecure https://uyuni-server-all-in-one-test-1:443/rhn/help/Copyright.do
      - name: start_sshd_in_server
        run: docker exec uyuni-server-all-in-one-test-1 bash -c "ssh-keygen -A && /usr/sbin/sshd -e"
      - name: copy_ssh_to_server
        run: docker exec uyuni-server-all-in-one-test-1 bash -c "if [ ! -d /root/.ssh ];then mkdir /root/.ssh/;chmod 700 /root/.ssh;fi;cp /tmp/authorized_keys /root/.ssh/"
      - name: set_up_sle_ssh_minion
        run: docker exec ssh-minion bash -c "echo 'root:linux' | chpasswd && echo 123456789 > /etc/machine-id"
      - name: copy_ssh_to_ssh_minion
        run: docker exec ssh-minion bash -c "if [ ! -d /root/.ssh ];then mkdir /root/.ssh/;chmod 700 /root/.ssh;fi;cp /tmp/authorized_keys /root/.ssh/"
      - name: copy_ssh_to_controller
        run: docker exec controller-test-1 bash -c "if [ ! -d /root/.ssh ];then mkdir /root/.ssh/;chmod 700 /root/.ssh;fi;cp /tmp/authorized_keys /root/.ssh/"
      - name: run_cucumber_core
        run: docker exec controller-test-1 bash -c "export CUCUMBER_PUBLISH_TOKEN=95eb386d-cb35-4824-a477-d827783c8f0c && export PROVIDER=docker && export SERVER=uyuni-server-all-in-one-test-1 && export HOSTNAME=controller-test-1 && cd /testsuite && rake cucumber:poc_core"
      - name: sle-salt-minion
        run: docker run --rm -d --network uyuni-network-1 -v /tmp/test-all-in-one:/tmp -v /home/runner/work/uyuni/uyuni/testsuite/salt-minion-entry-point.sh:/salt-minion-entry-point.sh --name sle_minion -h sle_minion ghcr.io/$UYUNI_PROJECT/uyuni/sle-minion:$UYUNI_VERSION /salt-minion-entry-point.sh uyuni-server-all-in-one-test-1 1-SUSE-KEY-x86_64
      - name: start_sshd_in_sle_salt_minion
        run: docker exec sle_minion bash -c "ssh-keygen -A && /usr/sbin/sshd -e"
      - name: copy_ssh_to_sle_salt_minion
        run: docker exec sle_minion bash -c "if [ ! -d /root/.ssh ];then mkdir /root/.ssh/;chmod 700 /root/.ssh;fi;cp /tmp/authorized_keys /root/.ssh/"
      - name: rhlike-minion
        run: docker run --rm -d --network uyuni-network-1 -v /tmp/test-all-in-one:/tmp -v /home/runner/work/uyuni/uyuni/testsuite/salt-minion-entry-point.sh:/salt-minion-entry-point.sh --name rhlike_minion -h rhlike_minion ghcr.io/$UYUNI_PROJECT/uyuni/rocky-minion:$UYUNI_VERSION /salt-minion-entry-point.sh uyuni-server-all-in-one-test-1 1-RH-LIKE-KEY
      - name: start_sshd_in_rhlike_minion
        run: docker exec rhlike_minion bash -c "ssh-keygen -A && /usr/sbin/sshd -e"
      - name: copy_ssh_to_rhlike_minion
        run: docker exec rhlike_minion bash -c "if [ ! -d /root/.ssh ];then mkdir /root/.ssh/;chmod 700 /root/.ssh;fi;cp /tmp/authorized_keys /root/.ssh/"
      - name: deblike-minion
        run: docker run --rm -d --network uyuni-network-1 -v /tmp/test-all-in-one:/tmp -v /home/runner/work/uyuni/uyuni/testsuite/salt-minion-entry-point.sh:/salt-minion-entry-point.sh --name deblike_minion -h deblike_minion ghcr.io/$UYUNI_PROJECT/uyuni/ubuntu-minion:$UYUNI_VERSION /salt-minion-entry-point.sh uyuni-server-all-in-one-test-1 1-DEBLIKE-KEY
      - name: start_sshd_in_deblike_minion
        run: docker exec deblike_minion bash -c "ssh-keygen -A && /usr/sbin/sshd -e"
      - name: copy_ssh_to_deblike_minion
        run: docker exec deblike_minion bash -c "if [ ! -d /root/.ssh ];then mkdir /root/.ssh/;chmod 700 /root/.ssh;fi;cp /tmp/authorized_keys /root/.ssh/"
      - name: run_cucumber_clients
        run: docker exec controller-test-1 bash -c "export CUCUMBER_PUBLISH_TOKEN=95eb386d-cb35-4824-a477-d827783c8f0c && export PROVIDER=docker && export SERVER=uyuni-server-all-in-one-test-1 && export HOSTNAME=controller-test-1 && export SSH_MINION=ssh-minion && export MINION=sle_minion && export RHLIKE_MINION=rhlike_minion && export DEBLIKE_MINION=deblike_minion && cd /testsuite && rake cucumber:poc_init_clients"
      - name: run_cucumber_secondary
        run: docker exec controller-test-1 bash -c "export CUCUMBER_PUBLISH_TOKEN=95eb386d-cb35-4824-a477-d827783c8f0c && export PROVIDER=docker && export SERVER=uyuni-server-all-in-one-test-1 && export HOSTNAME=controller-test-1 && export SSH_MINION=ssh-minion && export MINION=sle_minion && cd /testsuite && rake cucumber:secondary"
      - name: last-step
        run: echo "bye bye!"
