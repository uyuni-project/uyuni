{{- $config := .Values.global.config | fromYaml }}
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: squid-cache
  namespace: "{{ .Release.Namespace }}"
  labels:
    app.kubernetes.io/component: proxy
    app.kubernetes.io/part-of: uyuni
{{- if .Values.volumes.squid.extraLabels }}
{{ toYaml .Values.volumes.squid.extraLabels | nindent 4 }}
{{- end }}
{{- if .Values.volumes.squid.annotations }}
  annotations:
{{ toYaml .Values.volumes.squid.annotations | nindent 4 }}
{{- end }}
spec:
{{- if .Values.volumes.squid.storageClass }}
  {{- if eq "-" .Values.volumes.squid.storageClass }}
  storageClassName: ""
  {{- else }}
  storageClassName: {{ .Values.volumes.squid.storageClass | quote }}
  {{- end }}
{{- end }}
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: "{{ $config.max_cache_size_mb }}Mi"
{{- if .Values.volumes.squid.volumeName }}
  volumeName: {{ .Values.volumes.squid.volumeName | quote }}
{{- end }}
{{- if .Values.volumes.squid.selector }}
  selector:
{{ toYaml .Values.volumes.squid.selector | nindent 4 }}
{{- end }}
