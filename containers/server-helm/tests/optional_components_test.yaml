suite: test optional components (hub, coco, saline)
templates:
  - hub.yaml
  - coco.yaml
  - saline.yaml
tests:
  - it: should not render optional components by default
    set:
      global.fqdn: uyuni.example.com
    asserts:
      - hasDocuments:
          count: 0
        template: hub.yaml
      - hasDocuments:
          count: 0
        template: coco.yaml
      - hasDocuments:
          count: 0
        template: saline.yaml

  - it: should render hub-xmlrpc when hubAPI is true
    set:
      global.fqdn: uyuni.example.com
      hubAPI:
        enable: true
      pullPolicy: Always
    asserts:
      - equal:
          path: metadata.name
          value: hub-xmlrpc
        template: hub.yaml
        documentSelector:
          path: metadata.name
          value: hub-xmlrpc
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: "Always"
        template: hub.yaml
        documentSelector:
          path: metadata.name
          value: hub-xmlrpc
      - equal:
          path: spec.template.spec.containers[0].image
          value: "registry.opensuse.org/uyuni/server-hub-xmlrpc-api:latest"
        template: hub.yaml
        documentSelector:
          path: metadata.name
          value: hub-xmlrpc

  - it: should render coco-attestation with correct replicas
    set:
      global.fqdn: uyuni.example.com
      coco:
        replicas: 3
      pullPolicy: Always
    asserts:
      - equal:
          path: spec.replicas
          value: 3
        template: coco.yaml
        documentSelector:
          path: metadata.name
          value: coco-attestation
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: "Always"
        template: coco.yaml
        documentSelector:
          path: metadata.name
          value: coco-attestation
      - equal:
          path: spec.template.spec.containers[0].image
          value: "registry.opensuse.org/uyuni/server-attestation:latest"
        template: coco.yaml
        documentSelector:
          path: metadata.name
          value: coco-attestation

  - it: should render saline when enabled
    set:
      global.fqdn: uyuni.example.com
      saline:
        enable: true
      pullPolicy: Always
    asserts:
      - equal:
          path: metadata.name
          value: saline
        template: saline.yaml
        documentSelector:
          path: metadata.name
          value: saline
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: "Always"
        template: saline.yaml
        documentSelector:
          path: metadata.name
          value: saline
      - equal:
          path: spec.template.spec.containers[0].image
          value: "registry.opensuse.org/uyuni/server-saline:latest"
        template: saline.yaml
        documentSelector:
          path: metadata.name
          value: saline

  - it: should override the images when set
    set:
      global.fqdn: uyuni.example.com
      saline:
        enable: true
        image: example.org/test/saline
      coco:
        replicas: 3
        image: example.org/test/coco
      hubAPI:
        enable: true
        image: example.org/test/hub
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "example.org/test/saline:latest"
        template: saline.yaml
        documentSelector:
          path: metadata.name
          value: saline
      - equal:
          path: spec.template.spec.containers[0].image
          value: "example.org/test/coco:latest"
        template: coco.yaml
        documentSelector:
          path: metadata.name
          value: coco-attestation
      - equal:
          path: spec.template.spec.containers[0].image
          value: "example.org/test/hub:latest"
        template: hub.yaml
        documentSelector:
          path: metadata.name
          value: hub-xmlrpc
  
  - it: should override the images and tags when set
    set:
      global.fqdn: uyuni.example.com
      saline:
        enable: true
        image: example.org/test/saline
        tag: 1.1.1
      coco:
        replicas: 3
        image: example.org/test/coco
        tag: 1.1.2
      hubAPI:
        enable: true
        image: example.org/test/hub
        tag: 1.1.3
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "example.org/test/saline:1.1.1"
        template: saline.yaml
        documentSelector:
          path: metadata.name
          value: saline
      - equal:
          path: spec.template.spec.containers[0].image
          value: "example.org/test/coco:1.1.2"
        template: coco.yaml
        documentSelector:
          path: metadata.name
          value: coco-attestation
      - equal:
          path: spec.template.spec.containers[0].image
          value: "example.org/test/hub:1.1.3"
        template: hub.yaml
        documentSelector:
          path: metadata.name
          value: hub-xmlrpc
