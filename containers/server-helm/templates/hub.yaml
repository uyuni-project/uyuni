{{- if default .Values.hubAPI.enable false }}
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: hub-xmlrpc
    app.kubernetes.io/part-of: uyuni
  name: hub-xmlrpc
  namespace: "{{ .Release.Namespace }}"
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: hub-xmlrpc
      app.kubernetes.io/part-of: uyuni
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app.kubernetes.io/component: hub-xmlrpc
        app.kubernetes.io/part-of: uyuni
    spec:
      containers:
      - env:
        - name: HUB_API_URL
          value: http://web/rpc/api
        image: {{ include "uyuni.image" (dict "name" "server-hub-xmlrpc-api" "global" . "local" .Values.hubAPI) }}
        imagePullPolicy: {{ .Values.pullPolicy }}
        name: hub-xmlrpc
        ports:
        - containerPort: 2830
{{- if .Values.registrySecret }}
      imagePullSecrets:
      - name: {{ .Values.registrySecret }}
{{- end }}
      initContainers:
      - command:
        - sh
        - -c
        - |2
          until curl -L http://web/rhn/manager/api/api/getVersion; do
            sleep 60
          done
        image: {{ include "uyuni.image" (dict "name" "server-hub-xmlrpc-api" "global" . "local" .Values.hubAPI) }}
        imagePullPolicy: {{ .Values.pullPolicy }}
        name: server-waiter
{{- end }}
