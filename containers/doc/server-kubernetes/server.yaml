apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  labels:
    app: uyuni
  name: uyuni
spec:
  initContainers:
  - name: init-var-pgsql
    image: registry.opensuse.org/systemsmanagement/uyuni/master/servercontainer/containers/uyuni/server:latest
    command: ['sh', '-c', 'if [ -z "$(ls -A /mnt)" ]; then cp -rf /var/lib/pgsql/* /mnt; chown --reference=/var/lib/pgsql /mnt; chmod --reference=/var/lib/pgsql /mnt; fi']
    volumeMounts:
      - mountPath: /mnt
        name: var-pgsql
  - name: init-var-cache
    image: registry.opensuse.org/systemsmanagement/uyuni/master/servercontainer/containers/uyuni/server:latest
    command: ['sh', '-c', 'if [ -z "$(ls -A /mnt)" ]; then cp -rp /var/cache/* /mnt; chown --reference=/var/cache /mnt; chmod --reference=/var/cache /mnt; fi']
    volumeMounts:
      - mountPath: /mnt
        name: var-cache
  - name: init-var-log
    image: registry.opensuse.org/systemsmanagement/uyuni/master/servercontainer/containers/uyuni/server:latest
    command: ['sh', '-c', 'if [ -z "$(ls -A /mnt)" ]; then cp -rp /var/log/* /mnt; chown --reference=/var/log /mnt; chmod --reference=/var/log /mnt; fi']
    volumeMounts:
      - mountPath: /mnt
        name: var-log
  - name: init-srv-salt
    image: registry.opensuse.org/systemsmanagement/uyuni/master/servercontainer/containers/uyuni/server:latest
    command: ['sh', '-c', 'if [ -z "$(ls -A /mnt)" ]; then chown --reference=/srv/salt /mnt; chmod --reference=/srv/salt /mnt; fi']
    volumeMounts:
      - mountPath: /mnt
        name: srv-salt
  - name: init-srv-www-pub
    image: registry.opensuse.org/systemsmanagement/uyuni/master/servercontainer/containers/uyuni/server:latest
    command: ['sh', '-c', 'if [ -z "$(ls -A /mnt)" ]; then cp -rp /srv/www/htdocs/pub/* /mnt; ln -s /etc/pki/trust/anchors/LOCAL-RHN-ORG-TRUSTED-SSL-CERT /mnt/RHN-ORG-TRUSTED-SSL-CERT; chown --reference=/srv/www/htdocs/pub /mnt; chmod --reference=/srv/www/htdocs/pub /mnt; fi']
    volumeMounts:
      - mountPath: /mnt
        name: srv-www-pub
  - name: init-srv-www-cobbler
    image: registry.opensuse.org/systemsmanagement/uyuni/master/servercontainer/containers/uyuni/server:latest
    command: ['sh', '-c', 'if [ -z "$(ls -A /mnt)" ]; then cp -rp /srv/www/cobbler/* /mnt; chown --reference=/srv/www/cobbler /mnt; chmod --reference=/srv/www/cobbler /mnt; fi']
    volumeMounts:
      - mountPath: /mnt
        name: srv-www-cobbler
  - name: init-srv-www-osimages
    image: registry.opensuse.org/systemsmanagement/uyuni/master/servercontainer/containers/uyuni/server:latest
    command: ['sh', '-c', 'if [ -z "$(ls -A /mnt)" ]; then chown --reference=/srv/www/os-images /mnt; chmod --reference=/srv/www/os-images /mnt; fi']
    volumeMounts:
      - mountPath: /mnt
        name: srv-www-osimages
  - name: init-srv-tftpboot
    image: registry.opensuse.org/systemsmanagement/uyuni/master/servercontainer/containers/uyuni/server:latest
    command: ['sh', '-c', 'if [ -z "$(ls -A /mnt)" ]; then cp -rp /srv/tftpboot/* /mnt; chown --reference=/srv/tftpboot /mnt; chmod --reference=/srv/tftpboot /mnt; fi']
    volumeMounts:
      - mountPath: /mnt
        name: srv-tftpboot
  - name: init-srv-formulametadata
    image: registry.opensuse.org/systemsmanagement/uyuni/master/servercontainer/containers/uyuni/server:latest
    command: ['sh', '-c', 'if [ -z "$(ls -A /mnt)" ]; then cp -rp /srv/formula_metadata/* /mnt; chown --reference=/srv/formula_metadata /mnt; chmod --reference=/srv/formula_metadata /mnt; fi']
    volumeMounts:
      - mountPath: /mnt
        name: srv-formulametadata
  - name: init-srv-pillar
    image: registry.opensuse.org/systemsmanagement/uyuni/master/servercontainer/containers/uyuni/server:latest
    command: ['sh', '-c', 'if [ -z "$(ls -A /mnt)" ]; then cp -rp /srv/pillar/* /mnt; chown --reference=/srv/pillar /mnt; chmod --reference=/srv/pillar /mnt; fi']
    volumeMounts:
      - mountPath: /mnt
        name: srv-pillar
  - name: init-srv-susemanager
    image: registry.opensuse.org/systemsmanagement/uyuni/master/servercontainer/containers/uyuni/server:latest
    command: ['sh', '-c', 'if [ -z "$(ls -A /mnt)" ]; then cp -rp /srv/susemanager/* /mnt; chown --reference=/srv/susemanager /mnt; chmod --reference=/srv/susemanager /mnt; fi']
    volumeMounts:
      - mountPath: /mnt
        name: srv-susemanager
  - name: init-srv-spacewalk
    image: registry.opensuse.org/systemsmanagement/uyuni/master/servercontainer/containers/uyuni/server:latest
    command: ['sh', '-c', 'if [ -z "$(ls -A /mnt)" ]; then cp -rp /srv/spacewalk/* /mnt; chown --reference=/srv/spacewalk /mnt; chmod --reference=/srv/spacewalk /mnt; fi']
    volumeMounts:
      - mountPath: /mnt
        name: srv-spacewalk
  - name: init-root
    image: registry.opensuse.org/systemsmanagement/uyuni/master/servercontainer/containers/uyuni/server:latest
    command: ['sh', '-c', 'if [ -z "$(ls -A /mnt)" ]; then cp -rp /root/* /mnt; chown --reference=/root /mnt; chmod --reference=/root /mnt; fi']
    volumeMounts:
      - mountPath: /mnt
        name: root
  - name: init-etc-apache2
    image: registry.opensuse.org/systemsmanagement/uyuni/master/servercontainer/containers/uyuni/server:latest
    command: ['sh', '-c', 'if [ -z "$(ls -A /mnt)" ]; then cp -rp /etc/apache2/* /mnt; chown --reference=/etc/apache2 /mnt; chmod --reference=/etc/apache2 /mnt; fi']
    volumeMounts:
      - mountPath: /mnt
        name: etc-apache2
  - name: init-etc-rhn
    image: registry.opensuse.org/systemsmanagement/uyuni/master/servercontainer/containers/uyuni/server:latest
    command: ['sh', '-c', 'if [ -z "$(ls -A /mnt)" ]; then cp -rp /etc/rhn/* /mnt; chown --reference=/etc/rhn /mnt; chmod --reference=/etc/rhn /mnt; fi']
    volumeMounts:
      - mountPath: /mnt
        name: etc-rhn
  - name: init-etc-systemd
    image: registry.opensuse.org/systemsmanagement/uyuni/master/servercontainer/containers/uyuni/server:latest
    command: ['sh', '-c', 'if [ -z "$(ls -A /mnt)" ]; then cp -rp /etc/systemd/system/multi-user.target.wants/* /mnt; chown --reference=/etc/systemd/system/multi-user.target.wants /mnt; chmod --reference=/etc/systemd/system/multi-user.target.wants /mnt; fi']
    volumeMounts:
      - mountPath: /mnt
        name: etc-systemd
  - name: init-etc-salt
    image: registry.opensuse.org/systemsmanagement/uyuni/master/servercontainer/containers/uyuni/server:latest
    command: ['sh', '-c', 'if [ -z "$(ls -A /mnt)" ]; then cp -rp /etc/salt/* /mnt; chown --reference=/etc/salt /mnt; chmod --reference=/etc/salt /mnt; fi']
    volumeMounts:
      - mountPath: /mnt
        name: etc-salt
  - name: init-etc-tomcat
    image: registry.opensuse.org/systemsmanagement/uyuni/master/servercontainer/containers/uyuni/server:latest
    command: ['sh', '-c', 'if [ -z "$(ls -A /mnt)" ]; then cp -rp /etc/tomcat/* /mnt; chown --reference=/etc/tomcat /mnt; chmod --reference=/etc/tomcat /mnt; fi']
    volumeMounts:
      - mountPath: /mnt
        name: etc-tomcat
  - name: init-etc-cobbler
    image: registry.opensuse.org/systemsmanagement/uyuni/master/servercontainer/containers/uyuni/server:latest
    command: ['sh', '-c', 'if [ -z "$(ls -A /mnt)" ]; then cp -rp /etc/cobbler/* /mnt; chown --reference=/etc/cobbler /mnt; chmod --reference=/etc/cobbler /mnt; fi']
    volumeMounts:
      - mountPath: /mnt
        name: etc-cobbler
  - name: dir-init-tls
    image: registry.opensuse.org/systemsmanagement/uyuni/master/servercontainer/containers/uyuni/server:latest
    command: ['sh', '-c', 'if [ -z "$(ls -A /mnt)" ]; then ln -s /etc/pki/spacewalk-tls/spacewalk.crt /etc/pki/tls/certs/spacewalk.crt; ln -s /etc/pki/spacewalk-tls/spacewalk.key /etc/pki/tls/private/spacewalk.key; cp /etc/pki/spacewalk-tls/spacewalk.key /etc/pki/tls/private/pg-spacewalk.key; chown postgres:postgres /etc/pki/tls/private/pg-spacewalk.key; cp -rp /etc/pki/tls/* /mnt; chown --reference=/etc/pki/tls /mnt; chmod --reference=/etc/pki/tls /mnt; fi']
    volumeMounts:
      - mountPath: /mnt
        name: etc-tls
  containers:
  - name: uyuni
    image: registry.opensuse.org/systemsmanagement/uyuni/master/servercontainer/containers/uyuni/server:latest
    securityContext:
      capabilities:
        add:
          - SYS_ADMIN
    ports:
      - containerPort: 443
      - containerPort: 80
      - containerPort: 4505
      - containerPort: 4506
      - containerPort: 69
        protocol: UDP
      - containerPort: 25151
      - containerPort: 5432
      - containerPort: 8000
      - containerPort: 8001
    resources: {}
    volumeMounts:
      - mountPath: /run
        name: tmp
      - mountPath: /sys/fs/cgroup
        name: cgroup
      - mountPath: /var/lib/pgsql
        name: var-pgsql
      - mountPath: /var/cache
        name: var-cache
      - mountPath: /var/spacewalk
        name: var-spacewalk
      - mountPath: /var/log
        name: var-log
      - mountPath: /srv/salt
        name: srv-salt
      - mountPath: /srv/www/htdocs/pub
        name: srv-www-pub
      - mountPath: /srv/www/cobbler
        name: srv-www-cobbler
      - mountPath: /srv/www/os-images
        name: srv-www-osimages
      - mountPath: /srv/tftpboot
        name: srv-tftpboot
      - mountPath: /srv/formula_metadata
        name: srv-formulametadata
      - mountPath: /srv/pillar
        name: srv-pillar
      - mountPath: /srv/susemanager
        name: srv-susemanager
      - mountPath: /srv/spacewalk
        name: srv-spacewalk
      - mountPath: /root
        name: root
      - mountPath: /etc/apache2
        name: etc-apache2
      - mountPath: /etc/rhn
        name: etc-rhn
      - mountPath: /etc/systemd/system/multi-user.target.wants
        name: etc-systemd
      - mountPath: /etc/salt
        name: etc-salt
      - mountPath: /etc/tomcat
        name: etc-tomcat
      - mountPath: /etc/cobbler
        name: etc-cobbler
      - mountPath: /etc/pki/tls
        name: etc-tls
      - name: ca-cert
        mountPath: /etc/pki/trust/anchors/LOCAL-RHN-ORG-TRUSTED-SSL-CERT
        readOnly: true
        subPath: ca.crt
      - name: tls-key
        mountPath: /etc/pki/spacewalk-tls
      - name: uyuni-config
        mountPath: /root/setup_env.sh
        readOnly: true
        subPath: setup_env.sh
  volumes:
  - name: tmp
    emptyDir:
      medium: Memory
      sizeLimit: 256Mi
  - name: cgroup
    hostPath:
      path: /sys/fs/cgroup
      type: Directory
  - name: var-pgsql
    persistentVolumeClaim:
      claimName: var-pgsql
  - name: var-cache
    persistentVolumeClaim:
      claimName: var-cache
  - name: var-spacewalk
    persistentVolumeClaim:
      claimName: var-spacewalk
  - name: var-log
    persistentVolumeClaim:
      claimName: var-log
  - name: srv-salt
    persistentVolumeClaim:
      claimName: srv-salt
  - name: srv-www-pub
    persistentVolumeClaim:
      claimName: srv-www-pub
  - name: srv-www-cobbler
    persistentVolumeClaim:
      claimName: srv-www-cobbler
  - name: srv-www-osimages
    persistentVolumeClaim:
      claimName: srv-www-osimages
  - name: srv-tftpboot
    persistentVolumeClaim:
      claimName: srv-tftpboot
  - name: srv-formulametadata
    persistentVolumeClaim:
      claimName: srv-formulametadata
  - name: srv-pillar
    persistentVolumeClaim:
      claimName: srv-pillar
  - name: srv-susemanager
    persistentVolumeClaim:
      claimName: srv-susemanager
  - name: srv-spacewalk
    persistentVolumeClaim:
      claimName: srv-spacewalk
  - name: root
    persistentVolumeClaim:
      claimName: root
  - name: etc-apache2
    persistentVolumeClaim:
      claimName: etc-apache2
  - name: etc-rhn
    persistentVolumeClaim:
      claimName: etc-rhn
  - name: etc-systemd
    persistentVolumeClaim:
      claimName: etc-systemd
  - name: etc-salt
    persistentVolumeClaim:
      claimName: etc-salt
  - name: etc-tomcat
    persistentVolumeClaim:
      claimName: etc-tomcat
  - name: etc-cobbler
    persistentVolumeClaim:
      claimName: etc-cobbler
  - name: ca-cert
    configMap:
      name: uyuni-ca
  - name: etc-tls
    persistentVolumeClaim:
      claimName: etc-tls
  - name: tls-key
    secret:
      secretName: uyuni-cert
      items:
        - key: tls.crt
          path: spacewalk.crt
        - key: tls.key
          path: spacewalk.key
          mode: 0600
  - name: uyuni-config
    configMap:
      name: uyuni-config
  dnsPolicy: ClusterFirst
  restartPolicy: Always
