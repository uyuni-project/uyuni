apiVersion: batch/v1
kind: Job
metadata:
  name: uyuni-migration
spec:
  backoffLimit: 1
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: rsync-var-pgsql
        image: registry.opensuse.org/systemsmanagement/uyuni/master/servercontainer/containers/uyuni/server:latest
        command:
          - sh
          - -x
          - -c
          - >
            mkdir /root/.ssh;
            ssh-keyscan -t rsa uyuni.world-co.com >>~/.ssh/known_hosts;
            ln -s /root/keys/id_rsa /root/.ssh/id_rsa;
            ln -s /root/keys/id_rsa.pub /root/.ssh/id_rsa.pub;
            for folder in /var/lib/pgsql \
                          /var/cache \
                          /var/spacewalk \
                          /var/log \
                          /srv/salt \
                          /srv/www/htdocs/pub \
                          /srv/www/cobbler \
                          /srv/www/os-images \
                          /srv/tftpboot \
                          /srv/formula_metadata \
                          /srv/pillar \
                          /srv/susemanager \
                          /srv/spacewalk \
                          /root \
                          /etc/apache2 \
                          /etc/rhn \
                          /etc/systemd/system/multi-user.target.wants \
                          /etc/salt \
                          /etc/tomcat \
                          /etc/cobbler \
                          /etc/sysconfig;
            do
              rsync -avz uyuni.world-co.com:$folder/ $folder;
            done;
            rm -f /srv/www/htdocs/pub/RHN-ORG-TRUSTED-SSL-CERT;
            ln -s /etc/pki/trust/anchors/LOCAL-RHN-ORG-TRUSTED-SSL-CERT /srv/www/htdocs/pub/RHN-ORG-TRUSTED-SSL-CERT;
            echo 'server.no_ssl = 1' >> /etc/rhn/rhn.conf;
            sed 's/address=[^:]*:/address=uyuni:/' -i /etc/rhn/taskomatic.conf;
            sed 's/address=[^:]*:/address=uyuni:/' -i /etc/sysconfig/tomcat;
        volumeMounts:
          - mountPath: /var/lib/pgsql
            name: var-pgsql
          - mountPath: /var/cache
            name: var-cache
          - mountPath: /var/spacewalk
            name: var-spacewalk
          - mountPath: /var/log
            name: var-log
          - mountPath: /srv/salt
            name: srv-salt
          - mountPath: /srv/www/htdocs/pub
            name: srv-www-pub
          - mountPath: /srv/www/cobbler
            name: srv-www-cobbler
          - mountPath: /srv/www/os-images
            name: srv-www-osimages
          - mountPath: /srv/tftpboot
            name: srv-tftpboot
          - mountPath: /srv/formula_metadata
            name: srv-formulametadata
          - mountPath: /srv/pillar
            name: srv-pillar
          - mountPath: /srv/susemanager
            name: srv-susemanager
          - mountPath: /srv/spacewalk
            name: srv-spacewalk
          - mountPath: /root
            name: root
          - mountPath: /etc/apache2
            name: etc-apache2
          - mountPath: /etc/rhn
            name: etc-rhn
          - mountPath: /etc/systemd/system/multi-user.target.wants
            name: etc-systemd
          - mountPath: /etc/salt
            name: etc-salt
          - mountPath: /etc/tomcat
            name: etc-tomcat
          - mountPath: /etc/cobbler
            name: etc-cobbler
          - mountPath: /etc/sysconfig
            name: etc-sysconfig
          - mountPath: /root/keys
            name: ssh-key
      volumes:
        - name: var-pgsql
          persistentVolumeClaim:
            claimName: var-pgsql
        - name: var-cache
          persistentVolumeClaim:
            claimName: var-cache
        - name: var-spacewalk
          persistentVolumeClaim:
            claimName: var-spacewalk
        - name: var-log
          persistentVolumeClaim:
            claimName: var-log
        - name: srv-salt
          persistentVolumeClaim:
            claimName: srv-salt
        - name: srv-www-pub
          persistentVolumeClaim:
            claimName: srv-www-pub
        - name: srv-www-cobbler
          persistentVolumeClaim:
            claimName: srv-www-cobbler
        - name: srv-www-osimages
          persistentVolumeClaim:
            claimName: srv-www-osimages
        - name: srv-tftpboot
          persistentVolumeClaim:
            claimName: srv-tftpboot
        - name: srv-formulametadata
          persistentVolumeClaim:
            claimName: srv-formulametadata
        - name: srv-pillar
          persistentVolumeClaim:
            claimName: srv-pillar
        - name: srv-susemanager
          persistentVolumeClaim:
            claimName: srv-susemanager
        - name: srv-spacewalk
          persistentVolumeClaim:
            claimName: srv-spacewalk
        - name: root
          persistentVolumeClaim:
            claimName: root
        - name: etc-apache2
          persistentVolumeClaim:
            claimName: etc-apache2
        - name: etc-rhn
          persistentVolumeClaim:
            claimName: etc-rhn
        - name: etc-systemd
          persistentVolumeClaim:
            claimName: etc-systemd
        - name: etc-salt
          persistentVolumeClaim:
            claimName: etc-salt
        - name: etc-tomcat
          persistentVolumeClaim:
            claimName: etc-tomcat
        - name: etc-cobbler
          persistentVolumeClaim:
            claimName: etc-cobbler
        - name: etc-sysconfig
          persistentVolumeClaim:
            claimName: etc-sysconfig
        - name: ssh-key
          secret:
            secretName: migration-ssh-key
            items:
              - key: id_rsa
                mode: 0600
                path: id_rsa
              - key: id_rsa.pub
                mode: 0644
                path: id_rsa.pub
