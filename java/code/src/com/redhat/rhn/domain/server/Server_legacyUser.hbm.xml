<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE hibernate-mapping
PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
"classpath://org/hibernate/hibernate-mapping-3.0.dtd">
<hibernate-mapping>
    <class name="com.redhat.rhn.domain.server.Server" table="rhnServer">
        <id name="id" type="long" column="id">
            <meta attribute="scope-set">protected</meta>
            <generator class="sequence">
                <param name="sequence">rhn_server_id_seq</param>
            </generator>
        </id>

        <property name="digitalServerId" column="digital_server_id" type="string"
            length="1024"/>
        <property name="os" column="os" type="string" length="64"/>
        <property name="release" column="release" type="string" length="64"/>
        <property name="name" column="name" type="string" length="128"/>
        <property name="description" column="description" type="string"
            length="256"/>
        <property name="info" column="info" type="string" length="128"/>
        <property name="secret" column="secret" type="string" length="64"/>
        <property name="created" column="created" type="timestamp"
            insert="false" update="false"/>
        <property name="modified" column="modified" type="timestamp"
            insert="false" update="false"/>
        <property name="autoUpdate" column="auto_update" type="string" length="1"/>
        <property name="runningKernel" column="running_kernel" type="string"
            length="64"/>
        <property name="lastBoot" column="last_boot" type="long"/>
        <property name="channelsChanged" column="channels_changed" type="date"/>
        <property name="cobblerId" column="cobbler_id"  type="string" length="64" />
        <property name="machineId" column="machine_id"  type="string" length="256" />

        <set name="notes" cascade="all-delete-orphan" lazy="true" inverse="true">
            <key column="server_id"/>
            <one-to-many class="com.redhat.rhn.domain.server.Note"/>
        </set>

        <set name="devices" cascade="all" lazy="true" inverse="true">
            <key column="server_id"/>
            <one-to-many class="com.redhat.rhn.domain.server.Device"/>
        </set>

        <set name="networks" cascade="all, delete-orphan" lazy="true" inverse="true">
            <key column="server_id"/>
            <one-to-many class="com.redhat.rhn.domain.server.Network"/>
        </set>

        <set name="networkInterfaces" cascade="all" lazy="true" inverse="true">
            <key column="server_id"/>
            <one-to-many class="com.redhat.rhn.domain.server.NetworkInterface"/>
        </set>

        <set name="customDataValues" cascade="all" lazy="true" inverse="true">
            <key column="server_id"/>
            <one-to-many class="com.redhat.rhn.domain.server.CustomDataValue"/>
        </set>

        <set name="channels" lazy="true" table="rhnServerChannel" cascade="all">
            <key column="server_id"/>
            <many-to-many class="com.redhat.rhn.domain.channel.Channel"
                column="channel_id"/>
        </set>

        <list  name="configChannelsHibernate" lazy="true" table="rhnServerConfigChannel"
             cascade="all" where="(position > 0)"
         collection-type="com.redhat.rhn.common.hibernate.ForceRecreationListType">
             <key column="server_id"/>
            <list-index column="position" base="1"/>
            <many-to-many class="com.redhat.rhn.domain.config.ConfigChannel"
                column="config_channel_id"/>
        </list>

        <set  name="localChannels" lazy="true" table="rhnServerConfigChannel"
             cascade="all" where="(position is null)">
             <key column="server_id"/>
             <many-to-many class="com.redhat.rhn.domain.config.ConfigChannel"
                column="config_channel_id"/>
        </set>

        <set name="virtualGuests" inverse="true" lazy="true" outer-join="true"
            cascade="all">
                <key column="host_system_id"/>
                <one-to-many class="com.redhat.rhn.domain.server.VirtualInstance"/>
        </set>

                <set name="groups" table="rhnServerGroupMembers" inverse="true" lazy="true">
                        <key column="server_id"/>
                        <many-to-many column="server_group_id" class="com.redhat.rhn.domain.server.ServerGroup"/>
                </set>

        <set name="capabilities" lazy="true" inverse="true" table="rhnClientCapability" cascade="all-delete-orphan">
            <key column="server_id"/>
            <one-to-many class="com.redhat.rhn.domain.server.ClientCapability"/>
        </set>

        <many-to-one name="org" class="com.redhat.rhn.domain.org.Org"
            column="org_id" lazy="proxy"/>

        <many-to-one name="creator" class="com.redhat.rhn.domain.user.legacy.UserImpl"
            column="creator_id" lazy="proxy"/>

        <many-to-one name="serverArch"
            class="com.redhat.rhn.domain.server.ServerArch"
            column="server_arch_id" lazy="proxy"/>

        <many-to-one name="contactMethod"
            class="com.redhat.rhn.domain.server.ContactMethod"
            column="contact_method_id" lazy="proxy"/>

        <many-to-one name="provisionState"
            class="com.redhat.rhn.domain.common.ProvisionState"
            column="provision_state_id" cascade="save-update" lazy="proxy"/>

        <one-to-one name="serverInfo"
            class="com.redhat.rhn.domain.server.ServerInfo" cascade="all" lazy="proxy"/>

        <one-to-one name="serverPath"
            class="com.redhat.rhn.domain.server.ServerPath" cascade="all" lazy="proxy"/>

        <one-to-one name="cpu" class="com.redhat.rhn.domain.server.CPU"
            property-ref="server" cascade="all" lazy="proxy"/>

        <one-to-one name="crashCount" class="com.redhat.rhn.domain.server.CrashCount"
            cascade="all" lazy="proxy"/>

        <set name="crashes" cascade="all-delete-orphan" lazy="true" inverse="true">
            <key column="server_id"/>
            <one-to-many class="com.redhat.rhn.domain.server.Crash"/>
        </set>

        <one-to-one name="lock" class="com.redhat.rhn.domain.server.ServerLock"
                    cascade="all" lazy="proxy"/>

        <one-to-one name="serverUuid" class="com.redhat.rhn.domain.server.ServerUuid"
                    cascade="all" lazy="proxy"/>

        <one-to-one name="proxyInfo" class="com.redhat.rhn.domain.server.ProxyInfo"
                    cascade="all" lazy="proxy"/>

        <one-to-one name="pushClient" class="com.redhat.rhn.domain.server.PushClient"
                    property-ref="server" lazy="proxy" />

        <!--
        we want to access the ram object via the field directly.
        The setRam method is used to set the total amount of ram on
        a server with a long.  I don't want th users to have to
        create a RAM object on a server.
        -->
        <one-to-one name="ram" class="com.redhat.rhn.domain.server.Ram"
            property-ref="server" cascade="all" access="field" lazy="proxy"/>
        <one-to-one name="dmi" class="com.redhat.rhn.domain.server.Dmi"
            property-ref="server" cascade="all" lazy="proxy"/>
        <one-to-one name="location" class="com.redhat.rhn.domain.server.Location"
            property-ref="server" cascade="all" lazy="proxy" />

        <one-to-one name="virtualInstance"
                    class="com.redhat.rhn.domain.server.VirtualInstance"
                    property-ref="guestSystem"
                    cascade="save-update" lazy="proxy"/>

        <set name="history" cascade="all" lazy="true" inverse="true">
            <key column="server_id"/>
            <one-to-many class="com.redhat.rhn.domain.server.ServerHistoryEvent" />
        </set>

        <set name="packages" inverse="true" cascade="all-delete-orphan">
            <key column="server_id"/>
            <one-to-many class="com.redhat.rhn.domain.server.InstalledPackage"/>
        </set>

        <set name="installedProducts" table="suseServerInstalledProduct"
             lazy="true" cascade="save-update">
            <key column="rhn_server_id"/>
            <many-to-many column="suse_installed_product_id" class="com.redhat.rhn.domain.server.InstalledProduct"/>
        </set>

        <joined-subclass name="com.redhat.rhn.domain.server.SatelliteServer"
            table="rhnSatelliteInfo">
            <key column="server_id"/>
            <property name="cert" type="binary" column="cert" lazy="true"/>
            <property name="product" />
            <property name="owner" />
            <property name="issued" column="issued_string" />
            <property name="expiration" column="expiration_string" />
                <many-to-one name="version" class="com.redhat.rhn.domain.rhnpackage.PackageEvr"
                column="evr_id" cascade="none" access="field"/>
        </joined-subclass>

        <joined-subclass name="com.redhat.rhn.domain.server.MinionServer"
                         table="suseMinionInfo">
            <key column="server_id"/>
            <property name="minionId" column="minion_id" />
            <property name="osFamily" column="os_family"  type="string" length="32" />
        </joined-subclass>
    </class>

    <query name="Server.findByIdandOrgId">
        <![CDATA[from com.redhat.rhn.domain.server.Server as s where s.id = :sid and ORG_ID = :orgId]]>
    </query>

    <query name="Server.findByIdsAndOrgId">
        <![CDATA[from com.redhat.rhn.domain.server.Server as s where ORG_ID = :orgId and s.id in (:serverIds)]]>
    </query>

    <query name="Server.findByIds">
        <![CDATA[from com.redhat.rhn.domain.server.Server as s where s.id in (:serverIds)]]>
    </query>

     <query name="Server.listRedHatSystems">
        <![CDATA[ select s.id
                                        from com.redhat.rhn.domain.server.Server as s
                                        where s.id in (:sids) and s.serverArch.archType.label != 'sysv-solaris']]>
    </query>

     <query name="Server.listConfigEnabledSystems">
        <![CDATA[ select s
                                 from com.redhat.rhn.domain.server.Server as s
                                         inner join s.groups as sg
                                         inner join sg.groupType.features as f
                                         inner join s.capabilities as c
                                        where (sg.groupType is not null) and f.label='ftr_config' and c.id.capability.name like 'configfiles%']]>
    </query>

     <query name="Server.listConfigDiffEnabledSystems">
        <![CDATA[ select s
                      from com.redhat.rhn.domain.server.Server as s
                          inner join s.groups as sg
                          inner join sg.groupType.features as f
                          inner join s.capabilities as c
                      where (sg.groupType is not null) and f.label='ftr_config' and c.id.capability.name = 'configfiles.diff'
                      order by s.id asc
        ]]>
    </query>

    <sql-query name="Server.lookupAdministrators">
        <![CDATA[select {wc.*}
                                                from WEB_CONTACT wc
                                                inner join rhnUserServerPerms usp on wc.id = usp.user_id
                                                inner join rhnServer S on S.id = usp.server_id
                  where
                                s.id = :sid
                                and s.org_id = :org_id
                                ]]>
                <return alias="wc" class="com.redhat.rhn.domain.user.legacy.UserImpl"/>
    </sql-query>

    <sql-query name="Server.listProxies">
        <![CDATA[select S.id
                                        from rhnServer S
                                        inner join rhnUserServerPerms USP on USP.server_id = S.id
                                        inner join rhnProxyInfo rpi on rpi.server_id = S.id
                                        where S.org_id = :orgId
                                        and USP.user_id = :userId
                                ]]>
    </sql-query>

     <sql-query name="Server.findInSet">
     <![CDATA[
         select S.*,
           case when ss.server_id is not null then 2
                when proxy.server_id is not null then 3
                when S.id is not null then 0 end as clazz_
             from rhnServer S
                     left outer join  rhnSatelliteInfo SS on S.id = SS.server_id
                     left outer join  rhnProxyInfo proxy on S.id = proxy.server_id
                     inner join rhnSet ST on S.id = st.element
             where
                 ST.user_id = :userId
                 and ST.label = :label
                 and S.id not in (SELECT server_id FROM rhnProxyInfo)
           ]]>
        <return alias="S" class="com.redhat.rhn.domain.server.Server" />
    </sql-query>

    <sql-query name="Server.listErrataNamesForServers">
        <return-scalar column="errataId" type="long"/>
        <return-scalar column="serverId" type="long"/>
        <return-scalar column="advisoryName" type="string"/>
        <return-scalar column="updateTag" type="string"/>
        <![CDATA[select distinct e.id as errataId, sc.server_id as serverId, e.advisory_name as advisoryName, c.update_tag as updateTag
                 FROM rhnErrata e,
                      rhnServerChannel sc,
                      rhnChannelErrata ce,
                      rhnChannel c
                 WHERE e.id in (:errataIds) AND
                       sc.server_id in (:serverIds) AND
                       e.id = ce.errata_id AND
                       sc.channel_id = c.id AND
                       ce.channel_id = c.id
                                ]]>
    </sql-query>

    <sql-query name="Server.listNewestPkgsForServerErrata">
        <return-scalar column="serverId" type="long"/>
        <return-scalar column="packageName" type="string"/>
        <return-scalar column="packageVersion" type="string"/>
        <![CDATA[select X.server_id as serverId, X.name as packageName,
            case when (X.evr).epoch is null
                then (X.evr).version || '-' || (X.evr).release
                else (X.evr).epoch || ':' || (X.evr).version || '-' || (X.evr).release
            end  as packageVersion
            FROM ( select distinct sc.server_id, pn.name, max(pevr.evr) evr
                 FROM rhnErrata e,
                      rhnServerChannel sc,
                      rhnChannelErrata ce,
                      rhnErrataPackage ep,
                      rhnServerPackage sp,
                      rhnPackage p,
                      rhnPackageEVR pevr,
                      rhnPackageEVR spevr,
                      rhnPackageName pn
                 WHERE e.id in (:errataIds) AND
                      sc.server_id in (:serverIds) AND
                      e.id = ce.errata_id AND
                      sc.channel_id = ce.channel_id AND
                      e.id = ep.errata_id AND
                      ep.package_id = p.id AND
                      p.name_id = sp.name_id AND
                      p.evr_id = pevr.id AND
                      sp.evr_id = spevr.id AND
                      pevr.evr > spevr.evr AND
                      p.package_arch_id = sp.package_arch_id AND
                      p.name_id = pn.id
                 GROUP BY sc.server_id, pn.name) X]]>
    </sql-query>


</hibernate-mapping>
