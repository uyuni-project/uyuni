name: Java Unit Tests

on:
  push:
    branches:
      - master
    paths:
      - 'java/**.java'
      - 'java/**.xml'
      - '.github/workflows/java-unit-tests.yml'
  pull_request:
    paths:
      - 'java/**.java'
      - 'java/**.xml'
      - '.github/workflows/java-unit-tests.yml'

jobs:
  unittest:
    runs-on: ubuntu-latest
    container: registry.opensuse.org/systemsmanagement/uyuni/master/docker/containers/uyuni-master-pgsql:latest

    steps:
    - uses: actions/checkout@v3

    - name: Cache dependencies
      id: cache-dependencies
      uses: actions/cache@v3
      with:
        path: java/lib
        key: ${{ runner.os }}-java-lib-${{ hashFiles('java/buildconf/ivy/*.*') }}

    - name: Resolve dependencies
      if: steps.cache-dependencies.outputs.cache-hit != 'true'
      run: |
        ant -f java/manager-build.xml ivy refresh-branding-jar

    - name: Setup Environment
      run: |
        ln -s $(pwd) /manager
        cd /manager/susemanager-utils/testing/docker/scripts/
        ./reset_pgsql_database.sh
        cp /root/rhn.conf /etc/rhn/rhn.conf

    - name: Run unit tests
      run: |
        cd java
        cp buildconf/test/rhn.conf.postgresql-example buildconf/test/rhn.conf
        ant -f manager-build.xml refresh-branding-jar test-pr 2>&1

    - name: log out
      if: always() # always run even if the previous step fails
      run: |
        cat java/test-results/*.txt
        cat /var/log/rhn/rhn_web_ui.log
        su - postgres -c "/usr/lib/postgresql/bin/pg_ctl stop" ||:

    - name: Publish Test Report
      uses: mikepenz/action-junit-report@v3
      if: always() # always run even if the previous step fails
      with:
        report_paths: 'java/test-results/TEST-*.xml'

