<?xml version="1.0"?>

<!--
 - SUSE Manager build file for development use.
 - Please indent 2 spaces, NO TABS!
 -->
<project name="SUSE Manager" default="build_deploy" basedir=".">
  <!-- Import the main buildfile -->
  <import file="build.xml" />

  <!--
   - Set the prefix and webapp-dir before starting the installation.
   -->
  <target name="build_deploy" description="Build and (re-)install onto a local Tomcat 6 instance">
    <property name="prefix" value="" />
    <property name="webapp-dir" value="/var/lib/tomcat6/webapps/" />
    <echo message="webapp directory: ${webapp-dir}" />

    <!--
     - Link the 'tomcat-juli.jar', need to delete first though since the
     - failonerror seems to be not really working.
     -->
    <mkdir dir="${build.lib.dir}" />
    <delete file="${build.lib.dir}/tomcat-juli.jar" />
    <symlink link="${build.lib.dir}/tomcat-juli.jar"
             resource="/usr/share/tomcat6/bin/tomcat-juli.jar"
             failonerror="false"
             overwrite="true" />

    <!-- Run the installation -->
    <antcall target="install" />
  </target>

  <!--
   - This target is for apidoc installation.
   - (Overrides 'apidoc-install' in build.xml)
   -->
  <target name="apidoc-install"
          depends="apidoc-jsp"
          description="Copies apidoc to the target directory">
    <echo message="apidoc-install (${ant.file})" />
    <delete dir="${prefix}${webapp-dir}/rhn" failonerror="false" />
    <mkdir dir="${prefix}${webapp-dir}/rhn" />
    <mkdir dir="${prefix}${webapp-dir}/rhn/apidoc" />
    <mkdir dir="${prefix}${webapp-dir}/rhn/apidoc/handlers" />
    <!--
     - copy the apidocs to the right place
     -->
    <copy file="${build.dir}/reports/apidocs/jsp/index.jsp"
          toDir="${prefix}${webapp-dir}/rhn/apidoc"
          overwrite="true" />

    <copy file="${build.dir}/reports/apidocs/jsp/faqs.jsp"
          toDir="${prefix}${webapp-dir}/rhn/apidoc"
          overwrite="true" />

    <copy file="${build.dir}/reports/apidocs/jsp/scripts.jsp"
          toDir="${prefix}${webapp-dir}/rhn/apidoc"
          overwrite="true" />

    <copy toDir="${prefix}${webapp-dir}rhn/apidoc/handlers/">
        <fileset dir="${report.dir}/apidocs/jsp/handlers/" />
    </copy>
  </target>

  <!--
   - This target is for fast building and (re-)installing the webapp locally.
   - (Overrides 'install' in build.xml)
   -->
  <target name="install"
          depends="init-install,init,compile-all,pack,apidoc-jsp,apidoc-install,jspcompile"
          description="(Re-)Install the webapp to the directory specified by $prefix">
    <echo message="install (${ant.file})" />
    <mkdir dir="${prefix}/usr/share/rhn/lib" />
    <unjar src="${rhn.war}" dest="${prefix}${webapp-dir}/rhn" overwrite="true" />

    <!-- 
     - Copy the jar that contains our code to /usr/share/rhn/lib to be shared
     - between taskomatic and the webapp.
     -->
    <copy file="${prefix}${webapp-dir}/rhn/WEB-INF/lib/rhn.jar"
          toDir="${prefix}/usr/share/rhn/lib"
          overwrite="true" />

    <!--
     - Delete ALL of the jars, including rhn.jar, from the webapp so that
     - they can be replaced with symlinks.
     -->
    <delete>
      <fileset dir="${prefix}${webapp-dir}/rhn/WEB-INF/lib" >
        <include name="*.jar" />
      </fileset>
    </delete>

    <!-- Create symlinks for everything -->
    <jpackage-deps jars="${dist.jar.dependencies}"
        dir="${prefix}${webapp-dir}/rhn/WEB-INF/lib" />
    <symlink link="${prefix}${webapp-dir}/rhn/WEB-INF/lib/rhn.jar"
             resource="/usr/share/rhn/lib/rhn.jar"
             failonerror="false"
             overwrite="true" />

    <mkdir dir="${rhn-home}/buildconf/tempjars" />
    <copy toDir="${prefix}${webapp-dir}/rhn/WEB-INF/lib" overwrite="true">
      <fileset dir="${rhn-home}/buildconf/tempjars">
        <include name="**/*.jar" />
      </fileset>
    </copy>

    <!--
      - delete the symlinks for the jars that break the webapp.  Basically
      - these are the oracle jars and the servlet jars
      -->
    <delete verbose="true">
      <fileset dir="${prefix}${webapp-dir}/rhn/WEB-INF/lib">
        <include name="**/ojdbc*" />
        <include name="**/oracle-jdbc*" />
        <include name="**/servlet*" />
        <include name="**/logdriver*" />
        <include name="**/jspapi*" />
        <include name="**/jasper5-compiler*" />
        <!-- Added from spacewalk-java.spec -->
        <include name="**/tomcat6*" />
      </fileset>
    </delete>

    <!--
     - Create additional symlinks that are normally created during rpm build.
     - (see spacewalk-branding.spec)
     -->
    <symlink link="${prefix}${webapp-dir}/rhn/WEB-INF/lib/java-branding.jar"
             resource="/usr/share/rhn/lib/java-branding.jar"
             failonerror="false"
             overwrite="true" />
  </target>
</project>
