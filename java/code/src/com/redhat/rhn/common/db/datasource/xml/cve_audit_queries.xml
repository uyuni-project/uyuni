<datasource_modes>

<write-mode name="delete_relevant_channels">
  <query>
    DELETE FROM suseCVEServerChannel
  </query>
</write-mode>

<write-mode name="insert_relevant_channel">
  <query params="sid, cid, rank">
    INSERT INTO suseCVEServerChannel (server_id, channel_id, channel_rank)
    VALUES (:sid, :cid, :rank)
  </query>
</write-mode>

<mode name="find_relevant_products">
  <query>
    SELECT DISTINCT channel_product_id
      FROM rhnChannel
     WHERE id IN (%s)
  </query>
</mode>

<mode name="find_product_channels" class="com.redhat.rhn.domain.channel.Channel">
  <query params="parent">
    SELECT id FROM rhnChannel
     WHERE channel_product_id IN (%s)
       AND (parent_channel = :parent OR id = :parent)
  </query>
</mode>

<mode name="convert_suse_product_to_channel_products">
  <query params="suseProductId">
    select distinct c.channel_product_id
      from suseProducts sp
      join suseProductChannel spc ON spc.product_id = sp.id
      join rhnChannel c on spc.channel_id = c.id
     where sp.id = :suseProductId
  </query>
</mode>

<mode name="find_all_servers" class="com.redhat.rhn.frontend.dto.SystemOverview">
  <query>
    SELECT id FROM rhnServer
  </query>
</mode>

<mode name="count_cve_identifiers">
  <query params="cve_identifier">
    SELECT COUNT(*) AS count
      FROM rhnCVE
        JOIN rhnErrataCVE ON rhnErrataCVE.cve_id = rhnCVE.id
        JOIN rhnErrataPackage ON rhnErrataPackage.errata_id = rhnErrataCVE.errata_id
      WHERE rhnCVE.name = :cve_identifier
  </query>
</mode>
          
<mode name="list_systems_by_patch_status">
  <query params="cve_identifier, user_id">
    WITH affected_and_patched AS (
      SELECT rhnServerPackage.server_id as system_id,
        rhnServer.name as system_name,
        rhnChannelErrata.errata_id,
        rhnErrata.advisory as errata_advisory,
        rhnErrataPackage.package_id,
        (SELECT 1
            FROM rhnServerPackage sp, rhnPackageEVR sevr, rhnPackageUpgradeArchCompat puac
            WHERE rhnServerPackage.server_id = sp.server_id
              AND rhnServerPackage.name_id = sp.name_id
              AND sp.evr_id = sevr.id
              AND rhnPackageEVR.evr &lt;= sevr.evr
              AND rhnServerPackage.package_arch_id = puac.package_arch_id
              AND puac.package_upgrade_arch_id = sp.package_arch_id
        ) AS package_installed,
        rhnChannelErrata.channel_id,
        rhnChannel.name as channel_name,
        rhnChannel.label as channel_label,
        (SELECT 1
            FROM rhnChannelPackage cp, rhnServerChannel csc
            WHERE cp.channel_id = csc.channel_id
              AND rhnChannelPackage.package_id = cp.package_id
              AND rhnServerPackage.server_id = csc.server_id
              AND cp.channel_id = rhnChannelPackage.channel_id
        ) AS channel_assigned,
        suseCVEServerChannel.channel_rank
        FROM rhnChannelErrata,
          rhnErrata,
          rhnErrataPackage,
          rhnChannelPackage,
          rhnPackageEVR,
          rhnPackage,
          rhnServer,
          rhnServerPackage,
          rhnPackageUpgradeArchCompat,
          rhnCVE,
          rhnErrataCVE,
          rhnChannel,
          rhnUserServerPerms,
          suseCVEServerChannel
        WHERE rhnChannelErrata.errata_id = rhnErrataPackage.errata_id
          AND rhnErrata.id = rhnErrataPackage.errata_id
          AND rhnChannelErrata.channel_id = rhnChannelPackage.channel_id
          AND rhnErrataPackage.package_id = rhnChannelPackage.package_id
          AND rhnChannelErrata.channel_id = suseCVEServerChannel.channel_id
          AND rhnChannelPackage.package_id = rhnPackage.id
          AND rhnPackage.name_id = rhnServerPackage.name_id
          AND suseCVEServerChannel.server_id = rhnServerPackage.server_id
          AND rhnUserServerPerms.server_id = rhnServerPackage.server_id
          AND rhnServer.id = rhnServerPackage.server_id
          AND rhnPackage.evr_id = rhnPackageEVR.id
          AND rhnServerPackage.package_arch_id = rhnPackageUpgradeArchCompat.package_arch_id
          AND rhnPackageUpgradeArchCompat.package_upgrade_arch_id = rhnPackage.package_arch_id
          AND rhnChannelErrata.errata_id = rhnErrataCVE.errata_id
          AND rhnErrataCVE.cve_id = rhnCVE.id
          AND rhnChannelPackage.channel_id = rhnChannel.id
          AND rhnUserServerPerms.user_id = :user_id
          AND rhnCVE.name = :cve_identifier
    ),
    not_affected AS (
      SELECT rhnServer.id as system_id,
        rhnServer.name as system_name,
        CAST(NULL AS INTEGER) AS errata_id,
        CAST(NULL AS CHAR) AS errata_advisory,
        CAST(NULL AS INTEGER) AS package_id,
        CAST(NULL AS INTEGER) AS package_installed,
        CAST(NULL AS INTEGER) AS channel_id,
        CAST(NULL AS CHAR) AS channel_name,
        CAST(NULL AS CHAR) AS channel_label,
        CAST(NULL AS INTEGER) AS channel_assigned,
        CAST(NULL AS INTEGER) AS channel_rank
        FROM rhnServer
          JOIN rhnUserServerPerms
            ON rhnServer.id = rhnUserServerPerms.server_id
        WHERE  rhnUserServerPerms.user_id = :user_id
          AND rhnServer.id NOT IN (
            SELECT system_id FROM affected_and_patched
        )
    )
    SELECT * FROM (
        SELECT *
          FROM affected_and_patched
          UNION ALL (
            SELECT *
              FROM not_affected
          )
    ) X
    ORDER BY X.system_id, X.channel_rank, X.errata_id NULLS LAST
  </query>
</mode>

</datasource_modes>
