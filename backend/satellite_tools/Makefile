# Makefile for satellite_tool for RHNS
#
# $Id$

TOP	= ..

# Specific stuff
SUBDIR	= satellite_tools
SUBDIRS = exporter disk_dumper accounts repo_plugins
SPACEWALK_FILES	= __init__ connection constants diskImportLib messages \
            progress_bar req_channels satCerts satsync syncCache \
            sync_handlers \
            syncLib SequenceServer xmlDiskSource \
            xmlSource xmlWireSource rhn_satellite_activate rhn_ssl_dbstore \
            satComputePkgHeaders updatePackages reposync \
	    geniso
SCRIPTS = spacewalk-debug rhn-entitlement-report \
	  rhn-schema-version rhn-satellite-activate rhn-charsets \
	  rhn-ssl-dbstore update-packages rhn-db-stats rhn-schema-stats \
          spacewalk-repo-sync spacewalk-remove-channel \
	  spacewalk-update-signatures spacewalk-data-fsck satellite-sync

# check if we can build man pages
DOCBOOK = $(wildcard /usr/bin/docbook2man)

SGMLS	= $(wildcard *.sgml)
MANS	= $(patsubst %.sgml,%.8,$(SGMLS))

BINDIR	= /usr/bin
MANDIR	?= /usr/man
CRON_DAILY = /etc/cron.daily
FILLUP_DIR = /var/adm/fillup-templates

EXTRA_DIRS = $(MANDIR)/man8 $(BINDIR) $(CRON_DAILY) $(FILLUP_DIR)

SAT_ACTIV       = rhn-satellite-activate
CA_DBSTORE      = rhn-ssl-dbstore

REPOSYNC_CRON = cron/suse.de-clean-reposync-logs
REPOSYNC_SYSC = cron/sysconfig.reposync

include $(TOP)/Makefile.defs

# install scripts
all :: $(SCRIPTS)
install :: $(SCRIPTS) $(PREFIX)/$(BINDIR)
	$(INSTALL_BIN) $(SCRIPTS) $(PREFIX)/$(BINDIR)

ifneq ($(DOCBOOK),)
# install man pages
all	:: $(MANS)
install :: $(MANS) $(PREFIX)/$(MANDIR)
	$(INSTALL_DATA) $(MANS) $(PREFIX)/$(MANDIR)/man8
endif

install :: $(SAT_ACTIV).inst

install :: $(CA_DBSTORE).inst

# cron
install :: $(REPOSYNC_CRON) $(REPOSYNC_SYSC)
	$(INSTALL_DATA) $(REPOSYNC_SYSC) $(PREFIX)/$(FILLUP_DIR)/
	$(INSTALL_BIN) $(REPOSYNC_CRON) $(PREFIX)/$(CRON_DAILY)/

$(SAT_ACTIV).inst : $(SAT_ACTIV) $(SAT_ACTIV).new $(PREFIX)/$(BINDIR)
	$(INSTALL_BIN) $(SAT_ACTIV).new $(PREFIX)/$(BINDIR)/$(SAT_ACTIV)
	rm -f $(SAT_ACTIV).new

$(CA_DBSTORE).inst : $(CA_DBSTORE) $(CA_DBSTORE).new $(PREFIX)/$(BINDIR)
	$(INSTALL_BIN) $(CA_DBSTORE).new $(PREFIX)/$(BINDIR)/$(CA_DBSTORE)
	rm -f $(CA_DBSTORE).new


%.new : %
	sed -e 's|@@ROOT@@|$(ROOT)|g' <$* >$@

%.8 : %.sgml
	$(DOCBOOK) $<

clean ::
	@rm -fv $(MANS) manpage.* *.new

