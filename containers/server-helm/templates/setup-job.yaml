apiVersion: batch/v1
kind: Job
metadata:
  annotations: {}
  creationTimestamp: null
  labels:
    app.kubernetes.io/component: server-setup
    app.kubernetes.io/part-of: uyuni
  name: uyuni-setup-{{ now | date "20060102150405" }}
  namespace: "{{ .Release.Namespace }}"
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        app.kubernetes.io/component: server-setup
        app.kubernetes.io/part-of: uyuni
    spec:
      containers:
        - command:
          - /docker-entrypoint-init.d/00-mgrSetup.sh
          env:
            - name: ADMIN_USER
              valueFrom:
                secretKeyRef:
                  key: username
                  name: admin-credentials
                  optional: false
            - name: ADMIN_PASS
              valueFrom:
                secretKeyRef:
                  key: password
                  name: admin-credentials
                  optional: false
            - name: MANAGER_USER
              valueFrom:
                secretKeyRef:
                  key: username
                  name: db-credentials
                  optional: false
            - name: MANAGER_PASS
              valueFrom:
                secretKeyRef:
                  key: password
                  name: db-credentials
                  optional: false
            - name: REPORT_DB_USER
              valueFrom:
                secretKeyRef:
                  key: username
                  name: reportdb-credentials
                  optional: false
            - name: REPORT_DB_PASS
              valueFrom:
                secretKeyRef:
                  key: password
                  name: reportdb-credentials
                  optional: false
            - name: REPORT_DB_CA_CERT
              value: /etc/pki/trust/anchors/DB-RHN-ORG-TRUSTED-SSL-CERT
            - name: MANAGER_DB_NAME
              value: susemanager
            - name: MANAGER_DB_HOST
              value: db
            - name: MANAGER_DB_PORT
              value: "5432"
            - name: REPORT_DB_PORT
              value: "5432"
            - name: EXTERNALDB_PROVIDER
            - name: ISS_PARENT
            - name: NO_SSL
              value: "Y"
            - name: REPORT_DB_NAME
              value: reportdb
            - name: REPORT_DB_HOST
              value: reportdb
            - name: MANAGER_ADMIN_EMAIL
              valueFrom:
                configMapKeyRef:
                  key: email
                  name: uyuni-config
                  optional: false
            - name: MANAGER_MAIL_FROM
              valueFrom:
                configMapKeyRef:
                  key: email
                  name: uyuni-config
                  optional: false
            - name: UYUNI_FQDN
              valueFrom:
                configMapKeyRef:
                  key: fqdn
                  name: uyuni-config
                  optional: false
{{- if .Values.registrySecret }}
            - name: SCC_USER
              valueFrom:
                secretKeyRef:
                  key: username
                  name: {{ .Values.registrySecret }}
                  optional: false
            - name: SCC_PASS
              valueFrom:
                secretKeyRef:
                  key: password
                  name: {{ .Values.registrySecret }}
                  optional: false
{{- end }}
          image: {{ include "uyuni.image" (dict "name" "server" "global" . "local" .Values.server) }}
          imagePullPolicy: {{ .Values.pullPolicy }}
          name: setup
          volumeMounts:
            - mountPath: /var/lib/cobbler
              name: var-cobbler
            - mountPath: /var/lib/rhn/search
              name: var-search
            - mountPath: /var/lib/salt
              name: var-salt
            - mountPath: /var/cache
              name: var-cache
            - mountPath: /var/spacewalk
              name: var-spacewalk
            - mountPath: /var/log
              name: var-log
            - mountPath: /srv/salt
              name: srv-salt
            - mountPath: /srv/www/
              name: srv-www
            - mountPath: /srv/tftpboot
              name: srv-tftpboot
            - mountPath: /srv/formula_metadata
              name: srv-formulametadata
            - mountPath: /srv/pillar
              name: srv-pillar
            - mountPath: /srv/susemanager
              name: srv-susemanager
            - mountPath: /srv/spacewalk
              name: srv-spacewalk
            - mountPath: /root
              name: root
            - mountPath: /etc/pki/trust/anchors/
              name: ca-certs
            - mountPath: /run/salt/master
              name: run-salt-master
            - mountPath: /etc/apache2
              name: etc-apache2
            - mountPath: /etc/systemd/system/multi-user.target.wants
              name: etc-systemd-multi
            - mountPath: /etc/systemd/system/sockets.target.wants
              name: etc-systemd-sockets
            - mountPath: /etc/salt
              name: etc-salt
            - mountPath: /etc/tomcat
              name: etc-tomcat
            - mountPath: /etc/cobbler
              name: etc-cobbler
            - mountPath: /etc/sysconfig
              name: etc-sysconfig
            - mountPath: /etc/postfix
              name: etc-postfix
            - mountPath: /etc/sssd
              name: etc-sssd
            - mountPath: /etc/rhn
              name: etc-rhn
            - mountPath: /etc/pki/
              name: tls
{{- if .Values.registrySecret }}
      imagePullSecrets:
        - name: {{ .Values.registrySecret }}
{{- end }}
      initContainers:
        - command:
            - sh
            - -x
            - -c
            - |2
              # Fill he empty volumes
              for vol in /var/lib/cobbler \
                     /var/lib/salt \
                     /var/lib/pgsql \
                     /var/cache \
                     /var/log \
                     /srv/salt \
                     /srv/www \
                     /srv/tftpboot \
                     /srv/formula_metadata \
                     /srv/pillar \
                     /srv/susemanager \
                     /srv/spacewalk \
                     /root \
                     /etc/apache2 \
                     /etc/rhn \
                     /etc/systemd/system/multi-user.target.wants \
                     /etc/systemd/system/sockets.target.wants \
                     /etc/salt \
                     /etc/tomcat \
                     /etc/cobbler \
                     /etc/sysconfig \
                     /etc/postfix \
                     /etc/sssd
              do
                chown --reference=$vol /mnt$vol;
                chmod --reference=$vol /mnt$vol;
                if [ -z "$(ls -A /mnt$vol)" ]; then
                    cp -a $vol/. /mnt$vol;
                fi
              done
          image: {{ include "uyuni.image" (dict "name" "server" "global" . "local" .Values.server) }}
          imagePullPolicy: {{ .Values.pullPolicy }}
          name: init-volumes
          volumeMounts:
            - mountPath: /mnt/var/lib/cobbler
              name: var-cobbler
            - mountPath: /mnt/var/lib/rhn/search
              name: var-search
            - mountPath: /mnt/var/lib/salt
              name: var-salt
            - mountPath: /mnt/var/cache
              name: var-cache
            - mountPath: /mnt/var/spacewalk
              name: var-spacewalk
            - mountPath: /mnt/var/log
              name: var-log
            - mountPath: /mnt/srv/salt
              name: srv-salt
            - mountPath: /mnt/srv/www/
              name: srv-www
            - mountPath: /mnt/srv/tftpboot
              name: srv-tftpboot
            - mountPath: /mnt/srv/formula_metadata
              name: srv-formulametadata
            - mountPath: /mnt/srv/pillar
              name: srv-pillar
            - mountPath: /mnt/srv/susemanager
              name: srv-susemanager
            - mountPath: /mnt/srv/spacewalk
              name: srv-spacewalk
            - mountPath: /mnt/root
              name: root
            - mountPath: /mnt/etc/pki/trust/anchors/
              name: ca-certs
            - mountPath: /mnt/run/salt/master
              name: run-salt-master
            - mountPath: /mnt/etc/apache2
              name: etc-apache2
            - mountPath: /mnt/etc/systemd/system/multi-user.target.wants
              name: etc-systemd-multi
            - mountPath: /mnt/etc/systemd/system/sockets.target.wants
              name: etc-systemd-sockets
            - mountPath: /mnt/etc/salt
              name: etc-salt
            - mountPath: /mnt/etc/tomcat
              name: etc-tomcat
            - mountPath: /mnt/etc/cobbler
              name: etc-cobbler
            - mountPath: /mnt/etc/sysconfig
              name: etc-sysconfig
            - mountPath: /mnt/etc/postfix
              name: etc-postfix
            - mountPath: /mnt/etc/sssd
              name: etc-sssd
            - mountPath: /mnt/etc/rhn
              name: etc-rhn
        - command:
            - sh
            - -c
            - |2
              until pg_isready -U $MANAGER_USER -h $MANAGER_DB_HOST -p $MANAGER_DB_PORT -d $MANAGER_DB_NAME; do
                sleep 60
              done

              until pg_isready -U $REPORT_DB_USER -h $REPORT_DB_HOST -p $REPORT_DB_PORT -d $REPORT_DB_NAME; do
                sleep 60
              done
          env:
            - name: MANAGER_DB_HOST
              valueFrom:
                configMapKeyRef:
                  key: "db_host"
                  name: uyuni-config
                  optional: false
            - name: MANAGER_DB_PORT
              valueFrom:
                configMapKeyRef:
                  key: "db_port"
                  name: uyuni-config
                  optional: false
            - name: MANAGER_DB_NAME
              valueFrom:
                configMapKeyRef:
                  key: "db_name"
                  name: uyuni-config
                  optional: false
            - name: MANAGER_USER
              valueFrom:
                secretKeyRef:
                  key: username
                  name: db-credentials
                  optional: false
            - name: REPORT_DB_HOST
              valueFrom:
                configMapKeyRef:
                  key: "reportdb_host"
                  name: uyuni-config
                  optional: false
            - name: REPORT_DB_PORT
              valueFrom:
                configMapKeyRef:
                  key: "reportdb_port"
                  name: uyuni-config
                  optional: false
            - name: REPORT_DB_NAME
              valueFrom:
                configMapKeyRef:
                  key: "reportdb_name"
                  name: uyuni-config
                  optional: false
            - name: REPORT_DB_USER
              valueFrom:
                secretKeyRef:
                  key: username
                  name: reportdb-credentials
                  optional: false
          image: {{ include "uyuni.image" (dict "name" "server" "global" . "local" .Values.server) }}
          imagePullPolicy: {{ .Values.pullPolicy }}
          name: db-waiter
      restartPolicy: Never
      securityContext:
        seLinuxOptions:
          level: "s0"
      volumes:
        - name: var-cobbler
          persistentVolumeClaim:
            claimName: var-cobbler
        - name: var-search
          persistentVolumeClaim:
            claimName: var-search
        - name: var-salt
          persistentVolumeClaim:
            claimName: var-salt
        - name: var-cache
          persistentVolumeClaim:
            claimName: var-cache
        - name: var-spacewalk
          persistentVolumeClaim:
            claimName: var-spacewalk
        - name: var-log
          persistentVolumeClaim:
            claimName: var-log
        - name: srv-salt
          persistentVolumeClaim:
            claimName: srv-salt
        - name: srv-www
          persistentVolumeClaim:
            claimName: srv-www
        - name: srv-tftpboot
          persistentVolumeClaim:
            claimName: srv-tftpboot
        - name: srv-formulametadata
          persistentVolumeClaim:
            claimName: srv-formulametadata
        - name: srv-pillar
          persistentVolumeClaim:
            claimName: srv-pillar
        - name: srv-susemanager
          persistentVolumeClaim:
            claimName: srv-susemanager
        - name: srv-spacewalk
          persistentVolumeClaim:
            claimName: srv-spacewalk
        - name: root
          persistentVolumeClaim:
            claimName: root
        - name: ca-certs
          persistentVolumeClaim:
            claimName: ca-certs
        - name: run-salt-master
          persistentVolumeClaim:
            claimName: run-salt-master
        - name: etc-apache2
          persistentVolumeClaim:
            claimName: etc-apache2
        - name: etc-systemd-multi
          persistentVolumeClaim:
            claimName: etc-systemd-multi
        - name: etc-systemd-sockets
          persistentVolumeClaim:
            claimName: etc-systemd-sockets
        - name: etc-salt
          persistentVolumeClaim:
            claimName: etc-salt
        - name: etc-tomcat
          persistentVolumeClaim:
            claimName: etc-tomcat
        - name: etc-cobbler
          persistentVolumeClaim:
            claimName: etc-cobbler
        - name: etc-sysconfig
          persistentVolumeClaim:
            claimName: etc-sysconfig
        - name: etc-postfix
          persistentVolumeClaim:
            claimName: etc-postfix
        - name: etc-sssd
          persistentVolumeClaim:
            claimName: etc-sssd
        - name: etc-rhn
          persistentVolumeClaim:
            claimName: etc-rhn
        - configMap:
            name: uyuni-ca
          name: ca-cert
        - configMap:
            name: db-ca
          name: db-ca-cert
        - name: tls
          secret:
            items:
              - key: tls.crt
                path: tls/certs/spacewalk.crt
              - key: tls.key
                mode: 256
                path: tls/private/spacewalk.key
            secretName: uyuni-cert
        - configMap:
            name: db-ca
          name: db-ca
