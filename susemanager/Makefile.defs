# Common pathnames and programs for the spacewalk project
#
# $Id$

# if not defined, definit as a noop
TOP		?= .

# global defines which control this build and where we deploy files
ROOT		?= /usr/share/rhn
export ROOT

SPACEWALK_ROOT	?= $(shell $(PYTHON_BIN) -c "from distutils.sysconfig import get_python_lib; print(get_python_lib())")/spacewalk
export SPACEWALK_ROOT

PREFIX		?=
export PREFIX

# Compilation stuff
CC		= gcc
PYTHON_INCLUDE	= -I/usr/include/python$(PythonVersion)
CFLAGS		= -Wall -O2 -fomit-frame-pointer $(PYTHON_INCLUDE) -fPIC
SOFLAGS		= -shared -fPIC

# Installation stuff
INSTALL		= /usr/bin/install -c --verbose
INSTALL_BIN	= $(INSTALL) -m 755
INSTALL_DATA	= $(INSTALL) -m 644
INSTALL_DIR	= $(INSTALL) -m 755 -d

# This is for the subdir part
PYFILES		= $(addsuffix .py,$(FILES))

SPACEWALK_PYFILES		= $(addsuffix .py,$(SPACEWALK_FILES))

ifeq ($(PYTHON_BIN), python3)
SPACEWALK_PYCFILES = __pycache__/* mgr_sync/__pycache__/*
else
SPACEWALK_PYCFILES = $(addsuffix .pyc,$(SPACEWALK_FILES)) $(addsuffix .pyo,$(SPACEWALK_FILES))
endif
$(info DEBUG ORIG: $(SPACEWALK_PYCFILES))

SPACEWALK_DEST	?= $(SPACEWALK_ROOT)/$(SUBDIR)

# what do we need to install and where
INSTALL_FILES	+= $(PYFILES)
INSTALL_DEST	?= $(ROOT)/$(SUBDIR)

SPACEWALK_INSTALL_FILES	+= $(SPACEWALK_PYFILES)

DIRS		+= $(addprefix $(PREFIX), \
			$(sort $(EXTRA_DIRS)) $(INSTALL_DEST) $(SPACEWALK_ROOT) $(SPACEWALK_DEST))

all :: compileall $(INSTALL_FILES)

install :: all $(DIRS) $(INSTALL_FILES) $(SPACEWALK_INSTALL_FILES)
	$(INSTALL_DIR) $(PREFIX)$(SPACEWALK_DEST)/mgr_sync
ifeq ($(PYTHON_BIN), python3)
	$(INSTALL_DIR) $(PREFIX)$(SPACEWALK_DEST)/__pycache__
	$(INSTALL_DIR) $(PREFIX)$(SPACEWALK_DEST)/mgr_sync/__pycache__
endif
	@$(foreach f,$(INSTALL_FILES), \
		$(INSTALL_DATA) $(f) $(PREFIX)$(INSTALL_DEST)/$(f) ; )
	@$(foreach f,$(SPACEWALK_INSTALL_FILES), \
		$(INSTALL_DATA) $(f) $(PREFIX)$(SPACEWALK_DEST)/$(f) ; )
	@$(foreach f,$(wildcard $(SPACEWALK_PYCFILES)), \
		$(INSTALL_DATA) $(f) $(PREFIX)$(SPACEWALK_DEST)/$(f) ; )

$(DIRS):
	$(INSTALL_DIR) $@

clean ::
	@find . -name '*.pyc' -exec rm {} \;
	@find . -name '*.pyo' -exec rm {} \;
	@find . -name '__pycache__' -type d | xargs rm -rf
	@rm -fv *~ .??*~
	@rm -fv .\#*
	@rm -fv core

# default compile rules
compileall ::
	$(PYTHON_BIN) -c "import compileall; compileall.compile_dir('$(CURDIR)')"
	$(PYTHON_BIN) -OO -c "import compileall; compileall.compile_dir('$(CURDIR)')"

# useful macro
descend-subdirs = @$(foreach d,$(SUBDIRS), $(MAKE) -C $(d) $@ || exit 1; )

# subdirs are treated at the end
all install clean:: $(SUBDIRS)
	$(descend-subdirs)
