# Do not edit this file directly it will be overwritten by updates. Instead create your own custom config alongside it.

Logformat "%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \
\"%r\" %b \"%{Referer}i\" \"%{User-Agent}i\" %>s T%{ms}T"               ssl_combined

DocumentRoot "/usr/share/susemanager/www/htdocs"

<Directory "/usr/share/susemanager/www/htdocs">
    Options FollowSymLinks
    AllowOverride All
    <IfVersion <= 2.2>
        Order allow,deny
        Allow from all
    </IfVersion>
    <IfVersion >= 2.4>
        Require all granted
    </IfVersion>

    ExpiresActive On
    <FilesMatch "\.(js|css|ico|gif|png|pdf)$">
      ExpiresDefault A86400
      Header append Cache-Control "public"
    </FilesMatch>
</Directory>

Alias /icons/ "/usr/share/apache2/icons/"

<Directory "/usr/share/apache2/icons">
        Options MultiViews
        AllowOverride None
        <IfModule !mod_access_compat.c>
                Require all granted
        </IfModule>
        <IfModule mod_access_compat.c>
                Order allow,deny
                Allow from all
        </IfModule>
</Directory>

ScriptAlias /cgi-bin/ "/usr/share/susemanager/www/cgi-bin/"

<Directory "/usr/share/susemanager/www/cgi-bin">
        AllowOverride None
        Options +ExecCGI -Includes
        <IfModule !mod_access_compat.c>
                Require all granted
        </IfModule>
        <IfModule mod_access_compat.c>
                Order allow,deny
                Allow from all
        </IfModule>
</Directory>


# generic html; no session for vulnerability bots
ErrorDocument 404 /rhn/errors/404.jsp
ErrorDocument 500 /rhn/errors/500.jsp

<IfModule !proxy_ajp_module>
LoadModule proxy_ajp_module modules/mod_proxy_ajp.so
</IfModule>

<IfModule !proxy_wstunnel_module>
LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so
</IfModule>

# Turn rewrite engine on so we can use it for
# kickstart requests.
RewriteEngine on
RewriteOptions inherit
SSLProxyEngine on

# This rule handles incoming kickstart file requests from
# machines actually performing a kickstart. This rule
# processes the incoming URL and converts it into something
# slightly more Struts friendly.
RewriteRule ^/ks/cfg([-a-zA-Z0-9\._/\%\ ]*)$ /rhn/kickstart/DownloadFile.do?ksurl=$1
RewriteRule ^/download/(.*)$ /rhn/common/DownloadFile.do?url=/$1
RewriteRule ^/rpc/api /rhn/rpc/api

# Old branding AutoYast compatiblity link. Intentionally as redirect.
RewriteRule ^/ks/dist/child/sle-manager-tools(.*)$ /ks/dist/child/managertools-sle$1 [R,L]
RewriteRule ^/ks/dist(.*)$ /rhn/common/DownloadFile.do?url=/ks/dist$1 "[B= ?+,BNP]"
RewriteRule ^(/ty/.*)$ /rhn/common/DownloadFile.do?url=$1 "[B= ?+,BNP]"
RewriteRule ^/index\.html$ /rhn/manager/login

# for saltboot image redirection
RewriteRule ^(/saltboot/.*)$ /rhn$1

# For rhn-custom-info
RewriteRule ^/WEBRPC /rhn/rpc/api

# TEMPORARY: Next two rewrite rules are required for backward compatibility only.
# Should be deleted when all managed debian based systems updated with flat repos.
RewriteRule ^/rhn/manager/download/dists/(.*)/main/(.*)/(Packages.*)$ /rhn/manager/download/$1/repodata/$3
RewriteRule ^/rhn/manager/download/dists/(.*)/(InRelease|Release.*)$ /rhn/manager/download/$1/repodata/$2
# Rewrite rule for APT repos metadata
RewriteRule ^/rhn/manager/download/(.*)/(InRelease|Release.*|Packages.*)$ /rhn/manager/download/$1/repodata/$2

# Workaround for SLE11 Kiwi that unconditionally appends extra params to https urls
RewriteCond %{QUERY_STRING} ^(.*)\?credentials=kiwiRepoCredentials$
RewriteRule ^(/rhn/manager/download/.*)$ $1?%1

# increase timeout on proxy requests
ProxyTimeout 600

# Trust the Content-Length header from ajp (bsc#1226439)
SetEnv ap_trust_cgilike_cl

<IfModule proxy_ajp_module>
<Proxy ajp://localhost:8009>
  ProxySet min=1
</Proxy>
RewriteRule ^/rhn/Login2\.do ajp://localhost:8009/rhn/manager/login [P]
RewriteCond %{REQUEST_URI} !^/rhn/websocket
RewriteRule ^/rhn(.*) ajp://localhost:8009/rhn$1 [P]
</IfModule>

<IfModule proxy_wstunnel_module>
ProxyPass "/rhn/websocket" "ws://localhost:8080/rhn/websocket"
</IfModule>

ProxyPass "/saline" "http://saline:8216"
ProxyPassReverse "/saline" "http://saline:8216"
<Location /saline>
  ErrorDocument 502 "Saline server is not available"
</Location>

ProxyPass "/hub/rpc/api" "http://uyuni-hub-xmlrpc-0:2830/hub/rpc/api"
ProxyPassReverse "/hub/rpc/api" "http://uyuni-hub-xmlrpc-0:2830/hub/rpc/api"
<Location /hub/rpc/api>
  ErrorDocument 502 "Hub XML-RPC API  server is not available"
</Location>


# mod_xsendfile configuration
XSendFile on
XSendFilePath /var/spacewalk/packages
XSendFilePath /var/spacewalk/rhn/comps
XSendFilePath /var/spacewalk/rhn/modules
XSendFilePath /var/cache/rhn/repodata
<Directory /var/spacewalk/packages>
    <IfVersion <= 2.2>
        Order allow,deny
        Allow from all
    </IfVersion>
    <IfVersion >= 2.4>
        Require all granted
    </IfVersion>
</Directory>
<Directory /var/cache/rhn/repodata>
    <IfVersion <= 2.2>
        Order allow,deny
        Allow from all
    </IfVersion>
    <IfVersion >= 2.4>
        Require all granted
    </IfVersion>
</Directory>

RedirectMatch ^/renew/.* https://scc.suse.com/

# switch all cookies into HttpOnly cookies
# we have to do it on apache level because tomcat5-5.5.23 doesn't support them
Header edit Set-Cookie ^(pxt-session-cookie=.*)$ "$1; HttpOnly"
Header edit Set-Cookie ^(JSESSIONID=.*)$ "$1; HttpOnly"

# Disable TRACE and TRACK
RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK)
RewriteRule .* - [F]

ServerTokens Prod
ServerSignature Off

#prevent directory listing on these directories
<Directory "/var/www/html/css">
    Options None
</Directory>

<Directory "/var/www/html/errors">
    Options None
</Directory>

<Directory "/var/www/html/fonts">
    Options FollowSymLinks
</Directory>

<Directory "/var/www/html/img">
    Options None
</Directory>

<Directory "/var/www/html/javascript">
    Options None
</Directory>

# security related rules

# Whitelist of URIs that can be cached by a proxy
SetEnvIf Request_URI "/XMLRPC/GET-REQ" susemanager_static
SetEnvIf Request_URI "/ks/dist" susemanager_static
SetEnvIf Request_URI "/img" susemanager_static
SetEnvIf Request_URI "/css" susemanager_static
SetEnvIf Request_URI "/fonts" susemanager_static
SetEnvIf Request_URI "/javascript" susemanager_static
SetEnvIf Request_URI "/pub" susemanager_static
SetEnvIf Request_URI "/errors" susemanager_static
SetEnvIf Request_URI "/rhn/manager/download" susemanager_static
SetEnvIf Request_URI "/os-images" susemanager_static
SetEnvIf Request_URI "/saltboot" susemanager_static
SetEnvIf Request_URI "/tftp" susemanager_static
# Any non-whitelisted URI will not be cached by default
Header set Cache-Control "no-cache,no-store,must-revalidate,private" env=!susemanager_static
Header set Pragma "no-cache" env=!susemanager_static
Header set Expires 0 env=!susemanager_static

Header unset ETag
Header edit Set-Cookie ^(.*)$ $1;HttpOnly;Secure
Header always append X-Frame-Options SAMEORIGIN
Header set Content-Security-Policy: "default-src 'self' https: wss: ; script-src 'self' https: 'unsafe-inline' 'unsafe-eval'; img-src 'self' https: data: ;style-src 'self' https: 'unsafe-inline' "
Header set X-XSS-Protection "1; mode=block"
Header set X-Content-Type-Options "nosniff"
Header set X-Permitted-Cross-Domain-Policies "master-only"

# make sure the js MIME is not x-js
AddType "application/javascript" .js

# Make sure modules are loaded for response compression
<IfModule !filter_module>
  LoadModule filter_module modules/mod_filter.so
</IfModule>
<IfModule !deflate_module>
  LoadModule deflate_module modules/mod_deflate.so
</IfModule>

# Enable response compression for text types
<IfModule mod_deflate.c>
   AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json application/xml
</IfModule>

# Enable HSTS in Apache config
<IfModule mod_headers.c>
    Header always set Strict-Transport-Security "max-age=63072000; includeSubdomains; preload"
</IfModule>

# Force SameSite=Lax on all Set-Cookie headers
Header edit Set-Cookie ^(.*)$ $1;SameSite=lax
