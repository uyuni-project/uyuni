<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!--
 SUSE Manager build file for development use
 
 Builds and deploys the webapp to a SSH host running Tomcat, runs tests
 
 Requirements & configuration:
 
 https://github.com/SUSE/spacewalk/wiki/Java-Development-Environment
-->
<project name="SUSE Manager" default="deploy" basedir=".">
  <!-- Import common definitions -->
  <import file="buildconf/manager-common.xml" />
  
  <!-- Define tasks -->
  <target name="init-tests">
    <property name="build.tests" value="true" />
  </target>

  <target name="clean" description="Cleans up all generated files">
    <delete dir="${build.dir}" quiet="true">
      <exclude name="classes/**/*" if="precompiled" />
    </delete>
    <delete dir="${test.results.dir}" />
  </target>
	
  <target name="refresh-branding-jar" depends="clean" description="Compiles and builds the SUSE branding jar">
    <mkdir dir="${build.dir}/java-branding" />

    <javac destdir="${build.dir}/java-branding"
           source="1.6"
           target="1.6"
           includeantruntime="no"
           nowarn="true"
           srcdir="${branding.src.dir}" />

    <copy toDir="${build.dir}/java-branding">
      <fileset dir="${branding.src.dir}" excludes="**/*.java" />
    </copy>

    <jar destfile="${lib.dir}/java-branding.jar" includes="">
      <fileset dir="${build.dir}/java-branding" />
    </jar>
  </target>

  <target name="compile"
          depends="clean,refresh-branding-jar"
          unless="precompiled"
          description="Compiles the main codebase"
  >
    <mkdir dir="${build.dir}/classes" />
    <javac destdir="${build.dir}/classes"
           optimize="off"
           debug="on"
           source="1.6"
           target="1.6"
           deprecation="${deprecation}"
           nowarn="${nowarn}"
           encoding="utf-8"
           fork="yes"
           memoryMaximumSize="256m"
           includeAntRuntime="false"
           classpathref="libjars"
    >
      <src>
        <path location="code/src" />
        <path location="code/scripts/src" />
      </src>
      <exclude name="**/test/*.java" unless="build.tests" />
    </javac>

    <copy toDir="${build.dir}/classes">
      <fileset dir="${src.dir}/src">
        <exclude name="**/*.java" />
        <exclude name="**/package.html" />
      </fileset>
    </copy>
  </target>

  <target name="jar" depends="compile" description="Packs the main application jar">
    <jar destfile="${build.dir}/rhn.jar">
      <fileset dir="${build.dir}/classes">
        <!-- internal is not for publication; tlds go in META-INF;  html files go as javadoc -->
        <exclude name="**/internal/**" />
        <exclude name="**/*.tld" />
        <exclude name="**/*.html" />
        <exclude name="**/*.conf" />
        <exclude name="**/*.conf.rpmsave" />
        <exclude name="**/test/" unless="build.tests" />
        <exclude name="**/*/testing/**" unless="build.tests" />
        <exclude name="**/StringResource*.xml" unless="build.tests" />
      </fileset>
      <fileset dir="${build.dir}/classes">
        <include name="**/StringResource_en_US.xml" />
      </fileset>
      <!-- Can't be flattened like in <copy>, alas -->
      <metainf dir="${build.dir}/classes/com/redhat/rhn/frontend/taglibs">
        <include name="*.tld" />
      </metainf>
    </jar>
  </target>

  <target name="webapp" depends="jar" description="Creates the Web application directory">
    <copy todir="${build.dir}/webapp">
      <fileset dir="${src.dir}/webapp">
        <exclude name="help/**" />
      </fileset>
    </copy>

    <copy todir="${build.dir}/webapp/WEB-INF/lib">
      <fileset file="${build.dir}/rhn.jar" />
      <fileset dir="${lib.dir}">
        <include name="**/*.jar" />

        <!-- Don't copy unneded jars -->
        <exclude name="**/jasper*" />
        <exclude name="**/jspapi*" />
        <exclude name="**/tomcat6*" unless="build.tests" />
      </fileset>
      <fileset dir="${rhn-home}/buildconf/tempjars">
        <include name="**/*.jar" />
      </fileset>
    </copy>
  </target>

  <target name="deploy" depends="webapp" description="Deploys a new copy of SUSE Manager">
    <echo message="Copying files to remote host..." />
    <exec executable="rsync">
      <arg line="-a --delete ${build.dir}/webapp/ ${deploy.user}@${deploy.host}:${deploy.dir}/" />
    </exec>

    <exec command="ssh ${deploy.user}@${deploy.host}" inputstring='
        echo "Linking the branding jar...";
        mv ${deploy.dir}/WEB-INF/lib/java-branding.jar /usr/share/rhn/lib;
        ln -sf /usr/share/rhn/lib/java-branding.jar ${deploy.dir}/WEB-INF/lib/java-branding.jar;
  
        echo "Linking the main jar for Taskomatic...";
        mv ${deploy.dir}/WEB-INF/lib/rhn.jar /usr/share/rhn/lib;
        ln -sf /usr/share/rhn/lib/rhn.jar ${deploy.dir}/WEB-INF/lib;
      
        echo "Launching Tomcat restart...";
        nohup rctomcat6 restart > /dev/null 2>&amp;1 &amp;
      '
    />
  </target>

  <target name="deploy-images" description="Deploys images from the branding directory to the server">
    <echo message="Copying files to remote host..." />
    <exec executable="rsync">
      <arg line="-a ${branding.img.dir}/ ${deploy.user}@${deploy.host}:/srv/www/htdocs/img" />
    </exec>
  </target>

  <target name="deploy-tests" depends="init-tests,webapp" description="Deploy SUSE Manager tests">
    <echo message="Copying webapp files to remote host for running tests..." />
    <exec executable="rsync">
      <arg line="-a --delete ${build.dir}/webapp/ ${deploy.user}@${deploy.host}:${deploy.dir}/" />
    </exec>

    <exec command="ssh ${deploy.user}@${deploy.host}" inputstring='
        echo "Stopping Tomcat...";
        nohup rctomcat6 stop > /dev/null 2>&amp;1 &amp;

        echo "Linking the branding jar...";
        mv ${deploy.dir}/WEB-INF/lib/java-branding.jar /usr/share/rhn/lib;
        ln -sf /usr/share/rhn/lib/java-branding.jar ${deploy.dir}/WEB-INF/lib/java-branding.jar;

        echo "Linking the main jar for Taskomatic...";
        mv ${deploy.dir}/WEB-INF/lib/rhn.jar /usr/share/rhn/lib;
        ln -sf /usr/share/rhn/lib/rhn.jar ${deploy.dir}/WEB-INF/lib;
      '
    />
  </target>

  <target name="run-tests" depends="deploy-tests" description="Run unit tests remotely">
    <echo message="Copying files to remote host..." />
    <exec executable="scp" description="Copy ./buildconf directory to deploy host">
      <arg value="-r" />
      <arg line="buildconf ${deploy.user}@${deploy.host}:${deploy.dir}/WEB-INF" />
    </exec>
    <exec executable="scp" description="Copy test files to deploy host">
      <arg value="-r" />
      <arg line="code/src/com/redhat/rhn/common/conf/test/conf ${deploy.user}@${deploy.host}:/usr/share/rhn/unit-tests/" />
    </exec>

    <exec command="ssh ${deploy.user}@${deploy.host}" inputstring='
        cd ${deploy.dir}/WEB-INF;
        ant -f buildconf/manager-test.xml -Dlib.dir=${deploy.dir}/WEB-INF/lib -Dtest.jar=${deploy.dir}/WEB-INF/lib/rhn.jar -Dtest.configuration.path=/etc/rhn -Dtests.includes=${tests.includes} -Dtests.excludes=${tests.excludes};
      '
    />
  </target>

  <target name="run-tests-locally" depends="init-tests,jar" description="Run unit tests locally">
    <mkdir dir="/usr/share/rhn/unit-tests/conf"/>
    <copy toDir="/usr/share/rhn/unit-tests/conf">
      <fileset dir="code/src/com/redhat/rhn/common/conf/test/conf" />
    </copy>

    <property name="test.jar" value="${build.dir}/rhn.jar" />
    <property name="test.configuration.path" value="${basedir}/conf/local-tests" />
    <ant antfile="manager-test.xml" dir="buildconf"/>
  </target>
</project>
