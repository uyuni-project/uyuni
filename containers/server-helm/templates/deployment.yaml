apiVersion: apps/v1
kind: Deployment
metadata:
  name: uyuni
  namespace: "{{ .Release.Namespace }}"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: uyuni
  template:
    metadata:
      labels:
        app: uyuni
    spec:
      initContainers:
      - name: init-etc-tls
        image: {{- include "deployment.container.image" (dict "name" "server" "global" .) | indent 1}}
        command:
          - sh
          - -x
          - -c
          - >
            chown --reference=/etc/pki/tls /mnt;
            chmod --reference=/etc/pki/tls /mnt;
            if [ -z "$(ls -A /mnt)" ]; then
              cp -a /etc/pki/tls/. /mnt;
              ln -s /etc/pki/spacewalk-tls/spacewalk.crt /mnt/certs/spacewalk.crt;
              ln -s /etc/pki/spacewalk-tls/spacewalk.key /mnt/private/spacewalk.key;
              cp /etc/pki/spacewalk-tls/spacewalk.key /mnt/private/pg-spacewalk.key;
              chown postgres:postgres /mnt/private/pg-spacewalk.key;
            fi
        volumeMounts:
          - mountPath: /mnt
            name: etc-tls
          - name: tls-key
            mountPath: /etc/pki/spacewalk-tls
      - name: init-var-pgsql
        image: {{- include "deployment.container.image" (dict "name" "server" "global" .) | indent 1}}
        command:
          - sh
          - -x
          - -c
          - >
            chown --reference=/var/lib/pgsql /mnt;
            chmod --reference=/var/lib/pgsql /mnt;
            if [ -z "$(ls -A /mnt)" ]; then
              cp -a /var/lib/pgsql/. /mnt;
            fi
        volumeMounts:
          - mountPath: /mnt
            name: var-pgsql
      - name: init-var-cache
        image: {{- include "deployment.container.image" (dict "name" "server" "global" .) | indent 1}}
        command:
          - sh
          - -x
          - -c
          - >
            chown --reference=/var/cache /mnt;
            chmod --reference=/var/cache /mnt;
            if [ -z "$(ls -A /mnt)" ]; then
              cp -a /var/cache/. /mnt;
            fi
        volumeMounts:
          - mountPath: /mnt
            name: var-cache
      - name: init-var-log
        image: {{- include "deployment.container.image" (dict "name" "server" "global" .) | indent 1}}
        command:
          - sh
          - -x
          - -c
          - >
            chown --reference=/var/log /mnt;
            chmod --reference=/var/log /mnt;
            if [ -z "$(ls -A /mnt)" ]; then
              cp -a /var/log/. /mnt;
            fi
        volumeMounts:
          - mountPath: /mnt
            name: var-log
      - name: init-srv-salt
        image: {{- include "deployment.container.image" (dict "name" "server" "global" .) | indent 1}}
        command:
          - sh
          - -x
          - -c
          - >
            chown --reference=/srv/salt /mnt;
            chmod --reference=/srv/salt /mnt
        volumeMounts:
          - mountPath: /mnt
            name: srv-salt
      - name: init-srv-www-pub
        image: {{- include "deployment.container.image" (dict "name" "server" "global" .) | indent 1}}
        command:
          - sh
          - -x
          - -c
          - >
            chown --reference=/srv/www/htdocs/pub /mnt;
            chmod --reference=/srv/www/htdocs/pub /mnt;
            if [ -z "$(ls -A /mnt)" ]; then
              cp -a /srv/www/htdocs/pub/. /mnt;
              ln -s /etc/pki/trust/anchors/LOCAL-RHN-ORG-TRUSTED-SSL-CERT /mnt/RHN-ORG-TRUSTED-SSL-CERT;
            fi
        volumeMounts:
          - mountPath: /mnt
            name: srv-www-pub
      - name: init-srv-www-cobbler
        image: {{- include "deployment.container.image" (dict "name" "server" "global" .) | indent 1}}
        command:
          - sh
          - -x
          - -c
          - >
            chown --reference=/srv/www/cobbler /mnt;
            chmod --reference=/srv/www/cobbler /mnt;
            if [ -z "$(ls -A /mnt)" ]; then
              cp -a /srv/www/cobbler/. /mnt;
            fi
        volumeMounts:
          - mountPath: /mnt
            name: srv-www-cobbler
      - name: init-srv-www-osimages
        image: {{- include "deployment.container.image" (dict "name" "server" "global" .) | indent 1}}
        command:
          - sh
          - -x
          - -c
          - >
            chown --reference=/srv/www/os-images /mnt;
            chmod --reference=/srv/www/os-images /mnt
        volumeMounts:
          - mountPath: /mnt
            name: srv-www-osimages
      - name: init-srv-tftpboot
        image: {{- include "deployment.container.image" (dict "name" "server" "global" .) | indent 1}}
        command:
          - sh
          - -x
          - -c
          - >
            chown --reference=/srv/tftpboot /mnt;
            chmod --reference=/srv/tftpboot /mnt;
            if [ -z "$(ls -A /mnt)" ]; then
              cp -a /srv/tftpboot/. /mnt;
            fi
        volumeMounts:
          - mountPath: /mnt
            name: srv-tftpboot
      - name: init-srv-formulametadata
        image: {{- include "deployment.container.image" (dict "name" "server" "global" .) | indent 1}}
        command:
          - sh
          - -x
          - -c
          - >
            chown --reference=/srv/formula_metadata /mnt;
            chmod --reference=/srv/formula_metadata /mnt;
            if [ -z "$(ls -A /mnt)" ]; then
              cp -a /srv/formula_metadata/. /mnt;
            fi
        volumeMounts:
          - mountPath: /mnt
            name: srv-formulametadata
      - name: init-srv-pillar
        image: {{- include "deployment.container.image" (dict "name" "server" "global" .) | indent 1}}
        command:
          - sh
          - -x
          - -c
          - >
            chown --reference=/srv/pillar /mnt;
            chmod --reference=/srv/pillar /mnt;
            if [ -z "$(ls -A /mnt)" ]; then
              cp -a /srv/pillar/. /mnt;
            fi
        volumeMounts:
          - mountPath: /mnt
            name: srv-pillar
      - name: init-srv-susemanager
        image: {{- include "deployment.container.image" (dict "name" "server" "global" .) | indent 1}}
        command:
          - sh
          - -x
          - -c
          - >
            chown --reference=/srv/susemanager /mnt;
            chmod --reference=/srv/susemanager /mnt;
            if [ -z "$(ls -A /mnt)" ]; then
              cp -a /srv/susemanager/. /mnt;
            fi
        volumeMounts:
          - mountPath: /mnt
            name: srv-susemanager
      - name: init-srv-spacewalk
        image: {{- include "deployment.container.image" (dict "name" "server" "global" .) | indent 1}}
        command:
          - sh
          - -x
          - -c
          - >
            chown --reference=/srv/spacewalk /mnt;
            chmod --reference=/srv/spacewalk /mnt;
            if [ -z "$(ls -A /mnt)" ]; then
              cp -a /srv/spacewalk/. /mnt;
            fi
        volumeMounts:
          - mountPath: /mnt
            name: srv-spacewalk
      - name: init-root
        image: {{- include "deployment.container.image" (dict "name" "server" "global" .) | indent 1}}
        command:
          - sh
          - -x
          - -c
          - >
            chown --reference=/root /mnt;
            chmod --reference=/root /mnt;
            if [ -z "$(ls -A /mnt)" ]; then
              cp -a /root/. /mnt;
            fi
        volumeMounts:
          - mountPath: /mnt
            name: root
      - name: init-etc-apache2
        image: {{- include "deployment.container.image" (dict "name" "server" "global" .) | indent 1}}
        command:
          - sh
          - -x
          - -c
          - >
            chown --reference=/etc/apache2 /mnt;
            chmod --reference=/etc/apache2 /mnt;
            if [ -z "$(ls -A /mnt)" ]; then
              cp -a /etc/apache2/. /mnt;
            fi
        volumeMounts:
          - mountPath: /mnt
            name: etc-apache2
      - name: init-etc-rhn
        image: {{- include "deployment.container.image" (dict "name" "server" "global" .) | indent 1}}
        command:
          - sh
          - -x
          - -c
          - >
            chown --reference=/etc/rhn /mnt;
            chmod --reference=/etc/rhn /mnt;
            if [ -z "$(ls -A /mnt)" ]; then
              cp -a /etc/rhn/. /mnt;
            fi
        volumeMounts:
          - mountPath: /mnt
            name: etc-rhn
      - name: init-etc-systemd
        image: {{- include "deployment.container.image" (dict "name" "server" "global" .) | indent 1}}
        command:
          - sh
          - -x
          - -c
          - >
            chown --reference=/etc/systemd/system/multi-user.target.wants /mnt;
            chmod --reference=/etc/systemd/system/multi-user.target.wants /mnt;
            if [ -z "$(ls -A /mnt)" ]; then
              cp -a /etc/systemd/system/multi-user.target.wants/. /mnt;
            fi
        volumeMounts:
          - mountPath: /mnt
            name: etc-systemd
      - name: init-etc-salt
        image: {{- include "deployment.container.image" (dict "name" "server" "global" .) | indent 1}}
        command:
          - sh
          - -x
          - -c
          - >
            chown --reference=/etc/salt /mnt;
            chmod --reference=/etc/salt /mnt;
            if [ -z "$(ls -A /mnt)" ]; then
              cp -a /etc/salt/. /mnt;
            fi
        volumeMounts:
          - mountPath: /mnt
            name: etc-salt
      - name: init-etc-tomcat
        image: {{- include "deployment.container.image" (dict "name" "server" "global" .) | indent 1}}
        command:
          - sh
          - -x
          - -c
          - >
            chown --reference=/etc/tomcat /mnt;
            chmod --reference=/etc/tomcat /mnt;
            if [ -z "$(ls -A /mnt)" ]; then
              cp -a /etc/tomcat/. /mnt;
            fi
        volumeMounts:
          - mountPath: /mnt
            name: etc-tomcat
      - name: init-etc-cobbler
        image: {{- include "deployment.container.image" (dict "name" "server" "global" .) | indent 1}}
        command:
          - sh
          - -x
          - -c
          - >
            chown --reference=/etc/cobbler /mnt;
            chmod --reference=/etc/cobbler /mnt;
            if [ -z "$(ls -A /mnt)" ]; then
              cp -a /etc/cobbler/. /mnt;
            fi
        volumeMounts:
          - mountPath: /mnt
            name: etc-cobbler
      - name: init-etc-sysconfig
        image: {{- include "deployment.container.image" (dict "name" "server" "global" .) | indent 1}}
        command:
          - sh
          - -x
          - -c
          - >
            chown --reference=/etc/sysconfig /mnt;
            chmod --reference=/etc/sysconfig /mnt;
            if [ -z "$(ls -A /mnt)" ]; then
              cp -a /etc/sysconfig/. /mnt;
            fi
        volumeMounts:
          - mountPath: /mnt
            name: etc-sysconfig
      containers:
      - name: uyuni
        image: {{- include "deployment.container.image" (dict "name" "server" "global" .) | indent 1}}
        securityContext:
          capabilities:
            add:
              - SYS_ADMIN
        ports:
          - containerPort: 443
          - containerPort: 80
          - containerPort: 4505
          - containerPort: 4506
          - containerPort: 69
            protocol: UDP
          - containerPort: 25151
          - containerPort: 5432
{{- if .Values.exposeJavaDebug | default false }}
          - containerPort: 8000
          - containerPort: 8001
{{- end }}
        envFrom:
          - configMapRef:
              name: uyuni-config
          - secretRef:
              name: uyuni-secret
        volumeMounts:
          - mountPath: /run
            name: tmp
          - mountPath: /sys/fs/cgroup
            name: cgroup
          - mountPath: /var/lib/pgsql
            name: var-pgsql
          - mountPath: /var/cache
            name: var-cache
          - mountPath: /var/spacewalk
            name: var-spacewalk
          - mountPath: /var/log
            name: var-log
          - mountPath: /srv/salt
            name: srv-salt
          - mountPath: /srv/www/htdocs/pub
            name: srv-www-pub
          - mountPath: /srv/www/cobbler
            name: srv-www-cobbler
          - mountPath: /srv/www/os-images
            name: srv-www-osimages
          - mountPath: /srv/tftpboot
            name: srv-tftpboot
          - mountPath: /srv/formula_metadata
            name: srv-formulametadata
          - mountPath: /srv/pillar
            name: srv-pillar
          - mountPath: /srv/susemanager
            name: srv-susemanager
          - mountPath: /srv/spacewalk
            name: srv-spacewalk
          - mountPath: /root
            name: root
          - mountPath: /etc/apache2
            name: etc-apache2
          - mountPath: /etc/rhn
            name: etc-rhn
          - mountPath: /etc/systemd/system/multi-user.target.wants
            name: etc-systemd
          - mountPath: /etc/salt
            name: etc-salt
          - mountPath: /etc/tomcat
            name: etc-tomcat
          - mountPath: /etc/cobbler
            name: etc-cobbler
          - mountPath: /etc/sysconfig
            name: etc-sysconfig
          - mountPath: /etc/pki/tls
            name: etc-tls
          - name: ca-cert
            mountPath: /etc/pki/trust/anchors/LOCAL-RHN-ORG-TRUSTED-SSL-CERT
            readOnly: true
            subPath: ca.crt
          - name: tls-key
            mountPath: /etc/pki/spacewalk-tls
      volumes:
      - name: tmp
        emptyDir:
          medium: Memory
          sizeLimit: 256Mi
      - name: cgroup
        hostPath:
          path: /sys/fs/cgroup
          type: Directory
      - name: var-pgsql
        persistentVolumeClaim:
          claimName: var-pgsql
      - name: var-cache
        persistentVolumeClaim:
          claimName: var-cache
      - name: var-spacewalk
        persistentVolumeClaim:
          claimName: var-spacewalk
      - name: var-log
        persistentVolumeClaim:
          claimName: var-log
      - name: srv-salt
        persistentVolumeClaim:
          claimName: srv-salt
      - name: srv-www-pub
        persistentVolumeClaim:
          claimName: srv-www-pub
      - name: srv-www-cobbler
        persistentVolumeClaim:
          claimName: srv-www-cobbler
      - name: srv-www-osimages
        persistentVolumeClaim:
          claimName: srv-www-osimages
      - name: srv-tftpboot
        persistentVolumeClaim:
          claimName: srv-tftpboot
      - name: srv-formulametadata
        persistentVolumeClaim:
          claimName: srv-formulametadata
      - name: srv-pillar
        persistentVolumeClaim:
          claimName: srv-pillar
      - name: srv-susemanager
        persistentVolumeClaim:
          claimName: srv-susemanager
      - name: srv-spacewalk
        persistentVolumeClaim:
          claimName: srv-spacewalk
      - name: root
        persistentVolumeClaim:
          claimName: root
      - name: etc-apache2
        persistentVolumeClaim:
          claimName: etc-apache2
      - name: etc-rhn
        persistentVolumeClaim:
          claimName: etc-rhn
      - name: etc-systemd
        persistentVolumeClaim:
          claimName: etc-systemd
      - name: etc-salt
        persistentVolumeClaim:
          claimName: etc-salt
      - name: etc-tomcat
        persistentVolumeClaim:
          claimName: etc-tomcat
      - name: etc-cobbler
        persistentVolumeClaim:
          claimName: etc-cobbler
      - name: etc-sysconfig
        persistentVolumeClaim:
          claimName: etc-sysconfig
      - name: ca-cert
        configMap:
          name: uyuni-ca
      - name: etc-tls
        persistentVolumeClaim:
          claimName: etc-tls
      - name: tls-key
        secret:
          secretName: uyuni-cert
          items:
            - key: tls.crt
              path: spacewalk.crt
            - key: tls.key
              path: spacewalk.key
              mode: 0600
      dnsPolicy: ClusterFirst
      restartPolicy: Always
